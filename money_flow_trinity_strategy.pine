//@version=5
// Coder Stock - Money Flow Trinity Strategy (Wyckoff VSA + RSI Divergence)
// Chiáº¿n lÆ°á»£c: Trung háº¡n + Wyckoff VSA + RSI Divergence + SL 8%
// Author: Vinh
strategy(title="CS Trinity VSA Strategy", shorttitle="CS_Trinity_VSA_Strat", overlay=true, initial_capital=100000000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.15, pyramiding=0)

// ==========================================
// Cáº¤U HÃŒNH
// ==========================================
grp_cmf = "1. CMF"
cmf_len = input.int(20, "CMF Length", group=grp_cmf)

grp_ck = "2. Chaikin"
ck_fast = input.int(3, "Fast", group=grp_ck)
ck_slow = input.int(10, "Slow", group=grp_ck)

grp_vsa = "3. Wyckoff VSA"
vol_climax_mult = input.float(2.0, "Volume Climax (x TB)", group=grp_vsa)
vol_dry_mult = input.float(0.5, "Volume Cáº¡n (x TB)", group=grp_vsa)

grp_rsi = "4. RSI Divergence"
rsi_len = input.int(14, "RSI Length", group=grp_rsi)
pivot_lookback = input.int(5, "Pivot Lookback", group=grp_rsi)

grp_risk = "5. Quáº£n LÃ½ Vá»‘n"
sl_pct = input.float(8.0, "Stop Loss %", group=grp_risk)
tp1_pct = input.float(15.0, "Take Profit 1 % (Chá»‘t 50%)", group=grp_risk)
use_trailing = input.bool(true, "DÃ¹ng Trailing Stop?", group=grp_risk)
trail_pct = input.float(5.0, "Trailing Stop %", group=grp_risk)

grp_addon = "6. Cáº£nh BÃ¡o Äáº·c Biá»‡t"
i_vSpikeLb = input.bool(true, "Hiá»‡n ðŸš¦ (Vol Kiá»‡t sá»©c)", group=grp_addon)
i_vSpikeTh = input.float(4.669, "NgÆ°á»¡ng Vol Kiá»‡t sá»©c (x TB)", group=grp_addon)
i_hATRLb = input.bool(true, "Hiá»‡n âš¡ (Biáº¿n Ä‘á»™ng lá»ng láº»o)", group=grp_addon)
i_atr_mult = input.float(2.718, "NgÆ°á»¡ng Biáº¿n Ä‘á»™ng (x ATR)", group=grp_addon)

// ==========================================
// CALCULATIONS
// ==========================================

// CMF
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// Chaikin
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// EMAs
ema50 = ta.ema(close, 50)
ema144 = ta.ema(close, 144)
ema233 = ta.ema(close, 233)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)

// RSI
rsi_val = ta.rsi(close, rsi_len)
rsi_overbought = rsi_val > 70
rsi_oversold = rsi_val < 30

// ==========================================
// WYCKOFF VSA
// ==========================================

vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

is_vol_climax = vol_ratio >= vol_climax_mult
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult
is_vol_dry = vol_ratio < vol_dry_mult

atr_val = ta.atr(14)
spread = high - low
is_spread_wide = spread > atr_val * 1.5

is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)

// Volume Kiá»‡t sá»©c & Biáº¿n Ä‘á»™ng lá»ng láº»o
is_vol_exhaustion = vol_ratio >= i_vSpikeTh  // ðŸš¦
is_high_volatility = spread > atr_val * i_atr_mult  // âš¡
is_volatility_surge = is_vol_exhaustion or is_high_volatility

// VSA Patterns
is_spring = low < ema233 and close > ema233 and close > open
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5
easy_move_up = is_vol_dry and is_bullish and is_spread_wide

// ==========================================
// RSI DIVERGENCE
// ==========================================

price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)
rsi_pivot_low = ta.pivotlow(rsi_val, pivot_lookback, pivot_lookback)
price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
rsi_pivot_high = ta.pivothigh(rsi_val, pivot_lookback, pivot_lookback)

var float prev_price_low = na
var float prev_rsi_low = na
var float prev_price_high = na
var float prev_rsi_high = na

// Hidden Bullish: Price HL + RSI LL
hidden_bullish = false
if not na(price_pivot_low) and not na(prev_price_low)
    price_hl = low[pivot_lookback] > prev_price_low
    rsi_ll = rsi_val[pivot_lookback] < prev_rsi_low
    if price_hl and rsi_ll and rsi_val[pivot_lookback] < 50
        hidden_bullish := true

// Regular Bullish: Price LL + RSI HL
regular_bullish = false
if not na(price_pivot_low) and not na(prev_price_low)
    price_ll = low[pivot_lookback] < prev_price_low
    rsi_hl = rsi_val[pivot_lookback] > prev_rsi_low
    if price_ll and rsi_hl and rsi_val[pivot_lookback] < 40
        regular_bullish := true

// Bearish: Price HH + RSI LH
regular_bearish = false
if not na(price_pivot_high) and not na(prev_price_high)
    price_hh = high[pivot_lookback] > prev_price_high
    rsi_lh = rsi_val[pivot_lookback] < prev_rsi_high
    if price_hh and rsi_lh and rsi_val[pivot_lookback] > 60
        regular_bearish := true

if not na(price_pivot_low)
    prev_price_low := low[pivot_lookback]
    prev_rsi_low := rsi_val[pivot_lookback]

if not na(price_pivot_high)
    prev_price_high := high[pivot_lookback]
    prev_rsi_high := rsi_val[pivot_lookback]

// ==========================================
// SIGNALS
// ==========================================

is_slope_up = mf > mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]
ck_positive = ck_raw > 0
rsi_ok = rsi_val > 40 and rsi_val < 75

// Buy conditions
cond_trend_ok = ema_count_above >= 2
cond_cmf_ok = mf > 0 and is_slope_up
cond_vsa_bullish = accumulation_sign or is_spring or is_shakeout or easy_move_up

buy_signal = cond_trend_ok and cond_cmf_ok and rsi_ok and ck_positive
strong_buy = (buy_signal and cond_vsa_bullish) or hidden_bullish[pivot_lookback]
buy_early = ((is_spring or is_shakeout or accumulation_sign) and cmf_recovering) or regular_bullish[pivot_lookback]

// Exit conditions
cond_cmf_weak = mf < 0 and mf < mf[1] and mf[1] < mf[2]
cond_ema_weak = ema_count_above <= 1
cond_vsa_bearish = hidden_distribution or is_upthrust
death_cross = ta.crossunder(ema50, ema144)

exit_signal = (cond_cmf_weak and cond_ema_weak) or cond_vsa_bearish or regular_bearish[pivot_lookback] or death_cross

// ==========================================
// STRATEGY EXECUTION
// ==========================================

if strategy.position_size == 0
    if strong_buy
        strategy.entry("Long", strategy.long, comment="ðŸ’Ž Máº NH")
    else if buy_signal
        strategy.entry("Long", strategy.long, comment="âœ… MUA")
    else if buy_early
        strategy.entry("Long", strategy.long, comment="âš¡ Sá»šM")

if strategy.position_size > 0
    stop_price = strategy.position_avg_price * (1 - sl_pct/100)
    tp1_price = strategy.position_avg_price * (1 + tp1_pct/100)
    
    strategy.exit("TP1", qty_percent=50, limit=tp1_price, stop=stop_price, comment="Chá»‘t 50%")
    
    if use_trailing
        trail_points = close * trail_pct / 100 / syminfo.mintick
        strategy.exit("Trail", qty_percent=100, trail_points=trail_points, trail_offset=trail_points, stop=stop_price)

if strategy.position_size > 0 and exit_signal
    strategy.close_all(comment="ThoÃ¡t")

// ==========================================
// VISUALIZATION
// ==========================================

// Candle coloring
candle_color = is_volatility_surge and is_bullish ? color.new(color.yellow, 0) :
               is_volatility_surge and is_bearish ? color.new(color.fuchsia, 0) :
               is_vol_climax and is_bullish and close_position > 0.6 ? color.yellow :
               is_vol_climax and is_bearish and close_position > 0.6 ? color.aqua :
               is_vol_high and is_bullish ? color.teal :
               is_vol_high and is_bearish ? color.maroon :
               is_vol_dry ? color.gray :
               is_bullish ? color.green : color.red
barcolor(candle_color)

// EMAs
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4)

// VSA Icons - ðŸš¦ vÃ  âš¡
plotshape(i_vSpikeLb and is_vol_exhaustion, "ðŸš¦ Vol Kiá»‡t sá»©c", shape.circle, location.abovebar, color.red, text="ðŸš¦", size=size.small)
plotshape(i_hATRLb and is_high_volatility, "âš¡ Biáº¿n Ä‘á»™ng", shape.diamond, location.abovebar, color.yellow, text="âš¡", size=size.small)
plotshape(is_spring or is_shakeout, "Spring", shape.diamond, location.belowbar, color.aqua, size=size.small)
plotshape(accumulation_sign, "Accum", shape.triangleup, location.belowbar, color.lime, size=size.tiny)
plotshape(hidden_distribution, "Dist", shape.triangledown, location.abovebar, color.orange, size=size.tiny)

// RSI Divergence Icons
plotshape(hidden_bullish[pivot_lookback], "Hidden Bullish", shape.labelup, location.belowbar, color.blue, text="HD", size=size.small)
plotshape(regular_bullish[pivot_lookback], "Regular Bullish", shape.labelup, location.belowbar, color.purple, text="RD", size=size.small)
plotshape(regular_bearish[pivot_lookback], "Bearish Div", shape.labeldown, location.abovebar, color.red, text="BD", size=size.small)

// Background
bgcolor(strategy.position_size > 0 ? color.new(color.green, 90) : na)

// ==========================================
// DASHBOARD
// ==========================================
var table panel = table.new(position.top_right, 2, 7, border_width=1)
if barstate.islast
    table.cell(panel, 0, 0, "ðŸ‹ VSA+RSI", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    table.cell(panel, 0, 1, "Vá»‹ tháº¿:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 1, strategy.position_size > 0 ? "GIá»® ðŸ“ˆ" : "---", text_color=strategy.position_size > 0 ? color.green : color.gray)
    
    table.cell(panel, 0, 2, "RSI:", bgcolor=color.white, text_halign=text.align_left)
    rsi_text = rsi_overbought ? "OB âš ï¸" : rsi_oversold ? "OS ðŸ’¡" : str.tostring(rsi_val, "#")
    table.cell(panel, 1, 2, rsi_text, text_color=rsi_overbought ? color.red : rsi_oversold ? color.green : color.blue)
    
    table.cell(panel, 0, 3, "PhÃ¢n ká»³:", bgcolor=color.white, text_halign=text.align_left)
    div_text = hidden_bullish ? "HD ðŸ”µ" : regular_bullish ? "RD ðŸŸ£" : regular_bearish ? "BD ðŸ”´" : "---"
    table.cell(panel, 1, 3, div_text, text_color=hidden_bullish or regular_bullish ? color.green : regular_bearish ? color.red : color.gray)
    
    total = strategy.wintrades + strategy.losstrades
    wr = total > 0 ? strategy.wintrades / total * 100 : 0
    table.cell(panel, 0, 4, "Win:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 4, str.tostring(wr, "#.#") + "%", text_color=wr > 50 ? color.green : color.red)
    
    table.cell(panel, 0, 5, "Trades:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 5, str.tostring(strategy.closedtrades), text_color=color.blue)
    
    pnl = strategy.netprofit / strategy.initial_capital * 100
    table.cell(panel, 0, 6, "P&L:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 6, str.tostring(pnl, "#.#") + "%", text_color=pnl > 0 ? color.green : color.red)
