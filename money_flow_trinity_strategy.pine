//@version=5
// Coder Stock - Money Flow Trinity Strategy (Wyckoff VSA Edition)
// Chi·∫øn l∆∞·ª£c: Trung h·∫°n + Wyckoff VSA + Stop Loss 8% + Partial Profit
// Author: Vinh
strategy(title="CS Trinity VSA Strategy", shorttitle="CS_Trinity_VSA_Strat", overlay=true, initial_capital=100000000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.15, pyramiding=0)

// ==========================================
// C·∫§U H√åNH
// ==========================================
grp_cmf = "1. CMF"
cmf_len = input.int(20, "CMF Length", group=grp_cmf)

grp_ck = "2. Chaikin"
ck_fast = input.int(3, "Fast", group=grp_ck)
ck_slow = input.int(10, "Slow", group=grp_ck)

grp_vsa = "3. Wyckoff VSA"
vol_climax_mult = input.float(2.0, "Volume Climax (x TB)", group=grp_vsa)
vol_dry_mult = input.float(0.5, "Volume C·∫°n (x TB)", group=grp_vsa)

grp_risk = "4. Qu·∫£n L√Ω V·ªën"
sl_pct = input.float(8.0, "Stop Loss %", group=grp_risk)
tp1_pct = input.float(15.0, "Take Profit 1 % (Ch·ªët 50%)", group=grp_risk)
use_trailing = input.bool(true, "D√πng Trailing Stop?", group=grp_risk)
trail_pct = input.float(5.0, "Trailing Stop %", group=grp_risk)

// ==========================================
// CALCULATIONS
// ==========================================

// CMF
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// Chaikin
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// EMAs
ema50 = ta.ema(close, 50)
ema144 = ta.ema(close, 144)
ema233 = ta.ema(close, 233)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
ema_uptrend = ema50 > ema144 and ema144 > ema233

// ==========================================
// WYCKOFF VSA
// ==========================================

vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

is_vol_climax = vol_ratio >= vol_climax_mult
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult
is_vol_dry = vol_ratio < vol_dry_mult

is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)

// Spring
is_spring = low < ema233 and close > ema233 and close > open

// Shakeout
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish

// Accumulation
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6

// Hidden Distribution
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4

// Upthrust
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5

// Easy Move
atr_val = ta.atr(14)
spread = high - low
easy_move_up = is_vol_dry and is_bullish and spread > atr_val * 1.2

// Slope
is_slope_up = mf > mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]

// Crossovers
ck_cross_up = ta.crossover(ck_raw, 0)
ck_cross_down = ta.crossunder(ck_raw, 0)
ck_positive = ck_raw > 0

// RSI
rsi_val = ta.rsi(close, 14)
rsi_ok = rsi_val > 40 and rsi_val < 75

// ==========================================
// SIGNALS (Wyckoff Enhanced)
// ==========================================

// === MUA ===
cond_trend_ok = ema_count_above >= 2
cond_cmf_ok = mf > 0 and is_slope_up
cond_rsi_ok = rsi_ok
cond_vsa_bullish = accumulation_sign or is_spring or is_shakeout or easy_move_up

// Mua th∆∞·ªùng
buy_signal = cond_trend_ok and cond_cmf_ok and cond_rsi_ok and ck_positive

// Mua m·∫°nh (Wyckoff confirm)
strong_buy = buy_signal and cond_vsa_bullish

// Mua s·ªõm (Spring/Shakeout)
buy_early = (is_spring or is_shakeout or accumulation_sign) and cmf_recovering

// === B√ÅN ===
cond_cmf_weak = mf < 0 and mf < mf[1] and mf[1] < mf[2]
cond_ema_weak = ema_count_above <= 1
cond_vsa_bearish = hidden_distribution or is_upthrust
death_cross = ta.crossunder(ema50, ema144)

exit_signal = (cond_cmf_weak and cond_ema_weak) or cond_vsa_bearish or death_cross

// ==========================================
// STRATEGY EXECUTION
// ==========================================

// Entry
if strategy.position_size == 0
    if strong_buy
        strategy.entry("Long", strategy.long, comment="üíé VSA")
    else if buy_signal
        strategy.entry("Long", strategy.long, comment="‚úÖ MUA")
    else if buy_early
        strategy.entry("Long", strategy.long, comment="‚ö° S·ªöM")

// Exit management
if strategy.position_size > 0
    stop_price = strategy.position_avg_price * (1 - sl_pct/100)
    tp1_price = strategy.position_avg_price * (1 + tp1_pct/100)
    
    // Ch·ªët 50% t·∫°i TP1
    strategy.exit("TP1", qty_percent=50, limit=tp1_price, stop=stop_price, comment="Ch·ªët 50%")
    
    // Trailing cho 50% c√≤n l·∫°i
    if use_trailing
        trail_points = close * trail_pct / 100 / syminfo.mintick
        strategy.exit("Trail", qty_percent=100, trail_points=trail_points, trail_offset=trail_points, stop=stop_price)

// Exit khi VSA bearish
if strategy.position_size > 0 and exit_signal
    strategy.close_all(comment="H·∫øt Trend")

// ==========================================
// VISUALIZATION
// ==========================================

// Candle coloring
candle_color = is_vol_climax and is_bullish and close_position > 0.6 ? color.yellow :
               is_vol_climax and is_bearish and close_position > 0.6 ? color.aqua :
               is_vol_high and is_bullish ? color.teal :
               is_vol_high and is_bearish ? color.maroon :
               is_vol_dry ? color.gray :
               is_bullish ? color.green : color.red
barcolor(candle_color)

// EMAs
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4)

// VSA Icons
plotshape(is_vol_climax, "Climax", shape.circle, location.abovebar, color.yellow, size=size.tiny)
plotshape(is_spring or is_shakeout, "Spring", shape.diamond, location.belowbar, color.aqua, size=size.small)
plotshape(accumulation_sign, "Accum", shape.triangleup, location.belowbar, color.lime, size=size.tiny)
plotshape(hidden_distribution, "Dist", shape.triangledown, location.abovebar, color.orange, size=size.tiny)

// Background
bgcolor(strategy.position_size > 0 ? color.new(color.green, 90) : na)

// ==========================================
// DASHBOARD
// ==========================================
var table panel = table.new(position.top_right, 2, 6, border_width=1)
if barstate.islast
    table.cell(panel, 0, 0, "ÔøΩ VSA STRAT", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // Position
    table.cell(panel, 0, 1, "V·ªã th·∫ø:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 1, strategy.position_size > 0 ? "GI·ªÆ üìà" : "---", text_color=strategy.position_size > 0 ? color.green : color.gray)
    
    // Win Rate
    total = strategy.wintrades + strategy.losstrades
    wr = total > 0 ? strategy.wintrades / total * 100 : 0
    table.cell(panel, 0, 2, "Win Rate:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 2, str.tostring(wr, "#.#") + "%", text_color=wr > 50 ? color.green : color.red)
    
    // Trades
    table.cell(panel, 0, 3, "Trades:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 3, str.tostring(strategy.closedtrades), text_color=color.blue)
    
    // Profit
    pnl = strategy.netprofit / strategy.initial_capital * 100
    table.cell(panel, 0, 4, "P&L:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 4, str.tostring(pnl, "#.##") + "%", text_color=pnl > 0 ? color.green : color.red)
    
    // Profit Factor
    pf = strategy.grossprofit / (strategy.grossloss != 0 ? math.abs(strategy.grossloss) : 1)
    table.cell(panel, 0, 5, "PF:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 5, str.tostring(pf, "#.##"), text_color=pf > 1 ? color.green : color.red)
