//@version=6
// Coder Stock - Money Flow Trinity Strategy (Updated with Latest Logic)
// Author: Vinh
strategy(title="CS Trinity Master Strategy", shorttitle="CS Trinity Strat", overlay=true, 
         initial_capital=100000000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, 
         commission_type=strategy.commission.percent, commission_value=0.15, pyramiding=0)

// ==========================================
// SETTINGS
// ==========================================

// EMA Settings
grp_ema = "ðŸ“ˆ EMA Settings"
ema1_len = input.int(50, "EMA Ngáº¯n háº¡n (LÆ°á»›t sÃ³ng)", group=grp_ema)
ema2_len = input.int(144, "EMA Trung háº¡n", group=grp_ema)
ema3_len = input.int(233, "EMA DÃ i háº¡n", group=grp_ema)

// Ichimoku Cloud
i_showIchimoku = input.bool(true, "Hiá»‡n Ichimoku Cloud")

// RS Rating (IBD Style)
grp_rs = "ðŸ“Š RS Rating (IBD)"
i_showRS = input.bool(false, "Show RS Dashboard", group=grp_rs, tooltip="Hiá»‡n báº£ng RS Rating trÃªn gÃ³c chart")
i_benchmark = input.symbol("VNINDEX", "Benchmark Index", group=grp_rs, tooltip="Chá»‰ sá»‘ Ä‘á»ƒ so sÃ¡nh (VNINDEX, VN30, SPX...)")

// Display
grp_display = "ðŸŽ¨ Hiá»ƒn Thá»‹"
i_showHistogram = input.bool(true, "Hiá»‡n ðŸ“Š Money Flow Histogram", group=grp_display, tooltip="Histogram thá»ƒ hiá»‡n dÃ²ng tiá»n (xanh=mua, Ä‘á»=bÃ¡n)")
i_volSpikeLb = input.bool(true, "Hiá»‡n âš¡ Vol Äá»™t biáº¿n", group=grp_display, tooltip="Volume cao gáº¥p 2.5x MA20 + GiÃ¡ biáº¿n Ä‘á»™ng máº¡nh")
i_volDryLb = input.bool(true, "Hiá»‡n ðŸš¦ Vol Cáº¡n kiá»‡t", group=grp_display, tooltip="Volume tháº¥p + GiÃ¡ Ä‘i ngang = TÃ­ch lÅ©y")
i_candleColoring = input.bool(true, "TÃ´ mÃ u náº¿n theo biáº¿n Ä‘á»™ng", group=grp_display, tooltip="Náº¿n Ä‘áº­m = biáº¿n Ä‘á»™ng máº¡nh, náº¿n nháº¡t = biáº¿n Ä‘á»™ng yáº¿u")
i_showOB = input.bool(true, "Hiá»‡n ðŸ“¦ Order Block", group=grp_display, tooltip="Hiá»ƒn thá»‹ vÃ¹ng Order Block (cáº£n) trÃªn chart")

// Risk Management
grp_risk = "ðŸ’° Quáº£n LÃ½ Vá»‘n"
sl_pct = input.float(8.0, "Stop Loss %", group=grp_risk)
tp1_pct = input.float(15.0, "Take Profit 1 % (Chá»‘t 50%)", group=grp_risk)
use_trailing = input.bool(true, "DÃ¹ng Trailing Stop?", group=grp_risk)
trail_pct = input.float(5.0, "Trailing Stop %", group=grp_risk)

// Internal Settings (Hidden)
cmf_len = 20
ck_fast = 3
ck_slow = 10
vol_spike_threshold = 2.5
atr_mult_threshold = 2.0
ob_lookback = 20

// Ichimoku parameters
conversionPeriods = 9
basePeriods = 26
laggingSpan2Periods = 52
displacement = 26
cloudSupportThreshold = 0.003

// ==========================================
// CALCULATIONS
// ==========================================

// CMF (Chaikin Money Flow)
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// Chaikin Oscillator
ad_line = ta.cum(ad_val)
ck_fast_ema = ta.ema(ad_line, ck_fast)
ck_slow_ema = ta.ema(ad_line, ck_slow)
ck_raw = ck_fast_ema - ck_slow_ema

// Normalize Chaikin for visualization
price_range = ta.highest(high, 100) - ta.lowest(low, 100)
scaler = price_range * 0.05
ck_visual = ck_raw / (scaler != 0 ? scaler : 1)

// EMAs
ema50 = ta.ema(close, ema1_len)
ema144 = ta.ema(close, ema2_len)
ema233 = ta.ema(close, ema3_len)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233

// Trend Detection
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
is_confirmed_uptrend = ema_count_above >= 2
is_confirmed_downtrend = ema_count_above == 0

// Ichimoku Cloud
donchian(len) => math.avg(ta.lowest(len), ta.highest(len))
conversionLine = donchian(conversionPeriods)
baseLine = donchian(basePeriods)
leadLine1 = math.avg(conversionLine, baseLine)
leadLine2 = donchian(laggingSpan2Periods)

senkou_a = leadLine1[displacement]
senkou_b = leadLine2[displacement]
cloudTop = math.max(senkou_a, senkou_b)
cloudBottom = math.min(senkou_a, senkou_b)
cloudBullish = senkou_a > senkou_b

distance_to_cloud_support = cloudBullish and close > cloudBottom ? (close - cloudBottom) / close : na
at_cloud_support = not na(distance_to_cloud_support) and distance_to_cloud_support <= cloudSupportThreshold

distance_to_cloud_resistance = not cloudBullish and close < cloudTop ? (cloudTop - close) / close : na
at_cloud_resistance = not na(distance_to_cloud_resistance) and distance_to_cloud_resistance <= cloudSupportThreshold

// RSI
rsi_val = ta.rsi(close, 14)
rsi_overbought = rsi_val > 70
rsi_oversold = rsi_val < 30

// Volume Analysis
vol_ma20 = ta.sma(volume, 20)
vol_spike = volume > vol_ma20 * vol_spike_threshold

// ==========================================
// RS RATING (IBD STYLE) - CALCULATION
// ==========================================

benchmarkClose = request.security(i_benchmark, timeframe.period, close)

calcPerformance(lookback) =>
    if bar_index >= lookback
        currentPrice = close
        pastPrice = close[lookback]
        pastPrice != 0 ? ((currentPrice - pastPrice) / pastPrice) * 100 : 0
    else
        0

calcBenchmarkPerf(lookback) =>
    if bar_index >= lookback
        currentBench = benchmarkClose
        pastBench = benchmarkClose[lookback]
        pastBench != 0 ? ((currentBench - pastBench) / pastBench) * 100 : 0
    else
        0

perf_3m_stock = calcPerformance(63)
perf_6m_stock = calcPerformance(126)
perf_9m_stock = calcPerformance(189)
perf_12m_stock = calcPerformance(252)

perf_3m_bench = calcBenchmarkPerf(63)
perf_6m_bench = calcBenchmarkPerf(126)
perf_9m_bench = calcBenchmarkPerf(189)
perf_12m_bench = calcBenchmarkPerf(252)

stock_score = (perf_3m_stock * 0.4) + (perf_6m_stock * 0.2) + (perf_9m_stock * 0.2) + (perf_12m_stock * 0.2)
market_score = (perf_3m_bench * 0.4) + (perf_6m_bench * 0.2) + (perf_9m_bench * 0.2) + (perf_12m_bench * 0.2)

rs_diff = stock_score - market_score
rs_raw = 50 + (rs_diff * 0.8)
rs_rating = rs_raw > 99 ? 99 : rs_raw < 1 ? 1 : math.round(rs_raw)

// ==========================================
// MONEY FLOW SIGNALS
// ==========================================

// DÃ²ng tiá»n vÃ o máº¡nh
mf_count_positive = 0
for i = 0 to 2
    if mf[i] > 0.05
        mf_count_positive += 1

is_critical_inflow = mf_count_positive >= 3
is_strong_inflow = mf > 0.05
is_light_inflow = mf > 0 and mf <= 0.05

// DÃ²ng tiá»n ra máº¡nh
mf_count_negative = 0
for i = 0 to 2
    if mf[i] < -0.05
        mf_count_negative += 1

is_critical_outflow = mf_count_negative >= 3
is_strong_outflow = mf < -0.05

// Market choppy
is_choppy_market = math.abs(mf) < 0.02 and not vol_spike

// ==========================================
// STRATEGY SIGNALS
// ==========================================

// BUY CONDITIONS (Require above_ema50 for ALL signals - NO EXCEPTION)
strong_buy_condition = is_critical_inflow and is_confirmed_uptrend and above_ema50
buy_condition = is_strong_inflow and above_ema50 and above_ema233
early_buy_condition = is_light_inflow and above_ema50 and above_ema233 and rsi_oversold and at_cloud_support

// SELL CONDITIONS
strong_sell_condition = is_critical_outflow
sell_condition = is_strong_outflow or (not above_ema50 and is_confirmed_downtrend)

// ==========================================
// STRATEGY EXECUTION
// ==========================================

if strategy.position_size == 0
    if strong_buy_condition
        strategy.entry("Long", strategy.long, comment="ðŸ’Ž MUA Máº NH")
    else if buy_condition
        strategy.entry("Long", strategy.long, comment="âœ… MUA")
    else if early_buy_condition
        strategy.entry("Long", strategy.long, comment="âš¡ Sá»šM")

// Exit Logic - Trailing chá»‰ khi lÃ£i > 15%
if strategy.position_size > 0
    // TÃ­nh % lÃ£i hiá»‡n táº¡i
    current_profit_pct = (close - strategy.position_avg_price) / strategy.position_avg_price * 100
    
    // Stop Loss cá»‘ Ä‘á»‹nh
    stop_price = strategy.position_avg_price * (1 - sl_pct/100)
    
    // Chá»‰ báº­t trailing khi lÃ£i >= 15%
    if current_profit_pct >= tp1_pct and use_trailing
        // Trailing Stop (5% tá»« Ä‘á»‰nh)
        trail_points = close * trail_pct / 100 / syminfo.mintick
        strategy.exit("Trail", from_entry="Long", 
                     trail_points=trail_points, trail_offset=trail_points, 
                     stop=stop_price, comment="Trailing")
    else
        // ChÆ°a Ä‘á»§ lÃ£i 15% â†’ Chá»‰ SL cá»‘ Ä‘á»‹nh
        strategy.exit("SL", from_entry="Long", stop=stop_price, comment="Stop Loss")

// Exit khi cÃ³ sell signal máº¡nh
if strategy.position_size > 0 and (strong_sell_condition or sell_condition)
    strategy.close_all(comment="BÃN")

// ==========================================
// VISUALIZATION
// ==========================================

// Histogram
hline(0, "Zero", color.gray, hline.style_dotted)
plot(i_showHistogram ? mf : na, "CMF", style=plot.style_columns, color=mf > 0 ? color.new(color.teal, 40) : color.new(color.red, 40), linewidth=5)
plot(i_showHistogram ? ck_visual : na, "Chaikin", color=color.orange, linewidth=3)

// EMAs (Overlay)
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2, force_overlay=true)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3, force_overlay=true)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4, force_overlay=true)

// Ichimoku Cloud
p1 = plot(i_showIchimoku ? senkou_a : na, "Senkou A", color=color.new(color.green, 50), force_overlay=true)
p2 = plot(i_showIchimoku ? senkou_b : na, "Senkou B", color=color.new(color.red, 50), force_overlay=true)
fill(p1, p2, color=i_showIchimoku ? (cloudBullish ? color.new(color.green, 85) : color.new(color.red, 85)) : na)

// Volume Signals
plotshape(i_volSpikeLb and vol_spike, "âš¡ Vol Spike", shape.diamond, location.abovebar, color.yellow, text="âš¡", size=size.tiny, force_overlay=true)
plotshape(i_volDryLb and volume < vol_ma20 * 0.5, "ðŸš¦ Vol Dry", shape.circle, location.belowbar, color.lime, text="ðŸš¦", size=size.tiny, force_overlay=true)

// Candle Coloring
candle_color = i_candleColoring ? 
               (vol_spike and close > open ? color.new(color.yellow, 0) :
                vol_spike and close < open ? color.new(color.fuchsia, 0) :
                close > open ? color.green : color.red) : na
barcolor(candle_color)

// Background for position
bgcolor(strategy.position_size > 0 ? color.new(color.green, 90) : na)

// ==========================================
// DASHBOARD
// ==========================================
var table panel = table.new(position.top_right, 2, i_showRS ? 8 : 7, border_width=1, force_overlay=true)
if barstate.islast
    table.cell(panel, 0, 0, "ðŸ‹ TRINITY", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // Money Flow
    table.cell(panel, 0, 1, "DÃ²ng tiá»n:", bgcolor=color.white, text_halign=text.align_left)
    mf_text = is_critical_inflow ? "VÃ€O Máº NH âœ…" : 
              is_strong_inflow ? "VÃ€O ðŸ‘" : 
              is_critical_outflow ? "RA Máº NH âŒ" :
              is_strong_outflow ? "RA âš ï¸" : "TRUNG TÃNH"
    mf_color = is_critical_inflow or is_strong_inflow ? color.green : 
               is_critical_outflow or is_strong_outflow ? color.red : color.gray
    table.cell(panel, 1, 1, mf_text, text_color=mf_color)
    
    // Trend
    table.cell(panel, 0, 2, "Trung háº¡n:", bgcolor=color.white, text_halign=text.align_left)
    trend_text = is_confirmed_uptrend ? "UPTREND âœ…" : is_confirmed_downtrend ? "DOWNTREND âŒ" : "SIDEWAY"
    trend_color = is_confirmed_uptrend ? color.green : is_confirmed_downtrend ? color.red : color.orange
    table.cell(panel, 1, 2, trend_text, text_color=trend_color)
    
    // Surfing
    table.cell(panel, 0, 3, "LÆ°á»›t sÃ³ng:", bgcolor=color.white, text_halign=text.align_left)
    surf_text = above_ema50 ? "OK âœ…" : "DÆ¯á»šI âŒ"
    surf_color = above_ema50 ? color.green : color.red
    table.cell(panel, 1, 3, surf_text, text_color=surf_color)
    
    // Position
    table.cell(panel, 0, 4, "Vá»‹ tháº¿:", bgcolor=color.white, text_halign=text.align_left)
    pos_text = strategy.position_size > 0 ? "GIá»® ðŸ“ˆ" : "NGOÃ€I"
    pos_color = strategy.position_size > 0 ? color.green : color.gray
    table.cell(panel, 1, 4, pos_text, text_color=pos_color)
    
    // Win Rate
    total = strategy.wintrades + strategy.losstrades
    wr = total > 0 ? strategy.wintrades / total * 100 : 0
    table.cell(panel, 0, 5, "Win Rate:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 5, str.tostring(wr, "#.#") + "%", text_color=wr > 50 ? color.green : color.red)
    
    // P&L
    pnl = strategy.netprofit / strategy.initial_capital * 100
    table.cell(panel, 0, 6, "P&L:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 6, str.tostring(pnl, "#.#") + "%", text_color=pnl > 0 ? color.green : color.red)
    
    // RS Rating (Optional)
    if i_showRS
        table.cell(panel, 0, 7, "ðŸ“Š RS:", bgcolor=color.white, text_halign=text.align_left)
        rs_category = rs_rating > 80 ? "LEADER" : rs_rating >= 60 ? "AVERAGE" : "WEAK"
        rs_color = rs_rating > 80 ? color.green : rs_rating >= 60 ? color.orange : color.red
        rs_display = str.tostring(rs_rating) + " (" + rs_category + ")"
        table.cell(panel, 1, 7, rs_display, text_color=rs_color)
