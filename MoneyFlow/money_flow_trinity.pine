//@version=5
// Coder Stock - Money Flow Trinity Master (Wyckoff VSA + RSI Divergence)
// TÃ­ch há»£p: CMF + Chaikin + EOM + Wyckoff VSA + RSI Divergence
// Features: Candle Coloring, Volume Climax, Shakeout, RSI Divergence, Volatility Alert
// Author: Vinh
indicator(title="CS Trinity Master VSA", shorttitle="CS_Trinity_VSA", format=format.price, precision=2, max_lines_count=100)

// ==========================================
// 1. Cáº¤U HÃŒNH NGÆ¯á»œI DÃ™NG
// ==========================================
grp_ema = "ğŸ“ˆ EMA Settings"
ema1_len = input.int(50, "EMA Ngáº¯n háº¡n (LÆ°á»›t sÃ³ng)", group=grp_ema)
ema2_len = input.int(144, "EMA Trung háº¡n", group=grp_ema)
ema3_len = input.int(233, "EMA DÃ i háº¡n", group=grp_ema)

grp_display = "ğŸ¨ Hiá»ƒn Thá»‹"
i_volSpikeLb = input.bool(true, "Hiá»‡n âš¡ Vol Äá»™t biáº¿n", group=grp_display, tooltip="Volume cao gáº¥p 2.5x MA20 + GiÃ¡ biáº¿n Ä‘á»™ng máº¡nh")
i_volDryLb = input.bool(true, "Hiá»‡n ğŸš¦ Vol Cáº¡n kiá»‡t", group=grp_display, tooltip="Volume tháº¥p + GiÃ¡ Ä‘i ngang = TÃ­ch lÅ©y")
i_candleColoring = input.bool(true, "TÃ´ mÃ u náº¿n theo biáº¿n Ä‘á»™ng", group=grp_display, tooltip="Náº¿n Ä‘áº­m = biáº¿n Ä‘á»™ng máº¡nh, náº¿n nháº¡t = biáº¿n Ä‘á»™ng yáº¿u")
i_showOB = input.bool(true, "Hiá»‡n ğŸ“¦ Order Block", group=grp_display, tooltip="Hiá»ƒn thá»‹ vÃ¹ng Order Block (cáº£n) trÃªn chart")

// ==========================================
// CÃ€I Äáº¶T Ná»˜I Bá»˜ (áº¨N)
// ==========================================
cmf_len = 20
ck_fast = 3
ck_slow = 10
eom_len = 14
eom_div = 10000
vol_climax_mult = 2.0
vol_dry_mult = 0.5
spread_narrow = 0.5
rsi_len = 14
rsi_ob = 70
rsi_os = 30
pivot_lookback = 5
sell_cooldown = 3
buy_cooldown = 3
i_volSpikeTh = 2.5
i_volDryTh = 0.3

// ==========================================
// 2. TÃNH TOÃN CORE
// ==========================================

// --- CMF ---
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// --- Chaikin ---
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// --- EOM ---
dm = ((high + low) / 2) - ((high[1] + low[1]) / 2)
br = (volume / eom_div) / ((high - low) != 0 ? (high - low) : 1)
eom_inst = br != 0 ? dm / br : 0
eom_raw = ta.sma(eom_inst, eom_len)

// --- EMAs (CÃ³ thá»ƒ tÃ¹y chá»‰nh) ---
ema50 = ta.ema(close, ema1_len)
ema144 = ta.ema(close, ema2_len)
ema233 = ta.ema(close, ema3_len)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
resistance_count = 3 - ema_count_above

// Äáº¿m sá»‘ náº¿n liÃªn tiáº¿p trÃªn/dÆ°á»›i EMA233 Ä‘á»ƒ xÃ¡c nháº­n xu hÆ°á»›ng
var int candles_above_ema233 = 0
var int candles_below_ema233 = 0

if above_ema233
    candles_above_ema233 := candles_above_ema233 + 1
    candles_below_ema233 := 0
else
    candles_below_ema233 := candles_below_ema233 + 1
    candles_above_ema233 := 0

// Cáº§n Ã­t nháº¥t 3 náº¿n liÃªn tiáº¿p Ä‘á»ƒ xÃ¡c nháº­n xu hÆ°á»›ng
trend_confirm_count = 3
is_confirmed_uptrend = candles_above_ema233 >= trend_confirm_count
is_confirmed_downtrend = candles_below_ema233 >= trend_confirm_count
is_waiting_signal = not is_confirmed_uptrend and not is_confirmed_downtrend

// Äáº¿m sá»‘ láº§n Ä‘áº£o chiá»u tÃ­n hiá»‡u trong 10 náº¿n gáº§n Ä‘Ã¢y (phÃ¡t hiá»‡n thá»‹ trÆ°á»ng choppy)
signal_lookback = 10
max_flip_allowed = 3  // Náº¿u Ä‘áº£o chiá»u > 3 láº§n trong 10 náº¿n = choppy

// Äáº¿m sá»‘ láº§n giÃ¡ cross EMA233 trong lookback period
var int flip_count = 0
ema_cross = ta.cross(close, ema233)
flip_count := math.round(math.sum(ema_cross ? 1 : 0, signal_lookback))

// Äáº¿m sá»‘ láº§n dÃ²ng tiá»n Ä‘á»•i chiá»u
mf_cross = ta.cross(mf, 0)
mf_flip_count = math.round(math.sum(mf_cross ? 1 : 0, signal_lookback))

// Thá»‹ trÆ°á»ng choppy náº¿u cÃ³ quÃ¡ nhiá»u láº§n Ä‘áº£o chiá»u
is_choppy_market = flip_count > max_flip_allowed or mf_flip_count > max_flip_allowed

// Äáº¿m sá»‘ phiÃªn dÃ²ng tiá»n ra máº¡nh liÃªn tiáº¿p (mf < -0.1)
var int consecutive_strong_outflow = 0
var int consecutive_strong_inflow = 0
is_strong_outflow = mf < -0.1
is_strong_inflow = mf > 0.1
is_light_inflow = mf > 0 and mf <= 0.1

// Äáº¿m phiÃªn dÃ²ng tiá»n ra máº¡nh
if is_strong_outflow
    consecutive_strong_outflow := consecutive_strong_outflow + 1
    consecutive_strong_inflow := 0  // Reset inflow counter
else if mf > 0
    consecutive_strong_outflow := 0  // Reset khi dÃ²ng tiá»n vÃ o

// Äáº¿m phiÃªn dÃ²ng tiá»n vÃ o máº¡nh
if is_strong_inflow
    consecutive_strong_inflow := consecutive_strong_inflow + 1
else if mf < 0
    consecutive_strong_inflow := 0  // Reset khi dÃ²ng tiá»n ra

// Äáº¿m sá»‘ phiÃªn dÃ²ng tiá»n vÃ o nháº¹ liÃªn tiáº¿p
var int consecutive_light_inflow = 0
if is_light_inflow
    consecutive_light_inflow := consecutive_light_inflow + 1
else if mf < 0
    consecutive_light_inflow := 0  // Reset khi dÃ²ng tiá»n ra

// Cáº£nh bÃ¡o bÃ¡n háº¿t náº¿u dÃ²ng tiá»n ra máº¡nh >= 3 phiÃªn liÃªn tiáº¿p
critical_sessions = 3
light_inflow_confirm_sessions = 2  // Cáº§n 2 phiÃªn vÃ o nháº¹ Ä‘á»ƒ confirm
is_critical_outflow = consecutive_strong_outflow >= critical_sessions
is_critical_inflow = consecutive_strong_inflow >= critical_sessions  // Mua máº¡nh khi vÃ o máº¡nh 3+ phiÃªn
is_confirmed_light_inflow = consecutive_light_inflow >= light_inflow_confirm_sessions  // VÃ o nháº¹ 2+ phiÃªn

// --- RSI ---
rsi_val = ta.rsi(close, rsi_len)
rsi_overbought = rsi_val > rsi_ob
rsi_oversold = rsi_val < rsi_os

// ==========================================
// 3. WYCKOFF VSA ANALYSIS
// ==========================================

// --- Volume Analysis ---
vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

is_vol_climax = vol_ratio >= vol_climax_mult
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult
is_vol_normal = vol_ratio >= 0.8 and vol_ratio < 1.5
is_vol_dry = vol_ratio < vol_dry_mult

// --- Vol Äá»™t biáº¿n (Volume CAO + GiÃ¡ biáº¿n Ä‘á»™ng máº¡nh) ---
atr_val = ta.atr(14)
spread = high - low
is_price_moving = spread > atr_val * 1.5  // GiÃ¡ biáº¿n Ä‘á»™ng máº¡nh
is_vol_spike = vol_ratio >= i_volSpikeTh and is_price_moving  // âš¡ Vol Ä‘á»™t biáº¿n = Vol CAO + GiÃ¡ Ä‘á»™ng

// --- Spread Analysis ---
is_spread_wide = spread > atr_val * 1.5
is_spread_narrow = spread < atr_val * spread_narrow

// --- Volume Cáº¡n Kiá»‡t (Dry Volume) ---
// Vol tháº¥p + GiÃ¡ Ä‘i ngang (biÃªn Ä‘á»™ háº¹p) = Háº¿t ngÆ°á»i bÃ¡n, Ä‘ang tÃ­ch lÅ©y
is_vol_exhaustion = vol_ratio <= i_volDryTh and is_spread_narrow  // ğŸš¦ TÃ­n hiá»‡u tÃ­ch lÅ©y

// --- Candle Character ---
is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)

// --- VOLATILITY SURGE ---
// Vol Ä‘á»™t biáº¿n HOáº¶C Vol cáº¡n kiá»‡t Ä‘á»u lÃ  tÃ­n hiá»‡u quan trá»ng
is_volatility_surge = is_vol_spike or is_vol_exhaustion

// --- VSA Patterns ---
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish
is_spring = low < ema233 and close > ema233 and close > open
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5
easy_move_up = is_vol_dry and is_bullish and is_spread_wide

// ==========================================
// ORDER BLOCK DETECTION (Based on LuxAlgo)
// ==========================================
ob_length = 5  // Volume pivot length

// Order flow direction
var int ob_os = 0
ob_upper = ta.highest(high, ob_length)
ob_lower = ta.lowest(low, ob_length)
ob_os := high[ob_length] > ob_upper ? 0 : low[ob_length] < ob_lower ? 1 : ob_os[1]

// Volume pivot high
ob_phv = ta.pivothigh(volume, ob_length, ob_length)

// Bearish Order Block coordinates
var bear_ob_top = array.new_float(0)
var bear_ob_btm = array.new_float(0)
var bear_ob_time = array.new_int(0)  // Store creation time

// Detect new Bearish OB (Volume pivot + Downtrend)
is_bearish_ob = not na(ob_phv) and ob_os == 0
if is_bearish_ob
    array.unshift(bear_ob_top, high[ob_length])
    array.unshift(bear_ob_btm, hl2[ob_length])
    array.unshift(bear_ob_time, time[ob_length])  // Store the time of OB candle
    // Keep max 5 OBs
    if array.size(bear_ob_top) > 5
        array.pop(bear_ob_top)
        array.pop(bear_ob_btm)
        array.pop(bear_ob_time)

// Remove mitigated OBs (price > ob_top)
target_bear_ob = ta.highest(high, ob_length)
if array.size(bear_ob_top) > 0
    for i = array.size(bear_ob_top) - 1 to 0
        if i < array.size(bear_ob_top) and target_bear_ob > array.get(bear_ob_top, i)
            array.remove(bear_ob_top, i)
            array.remove(bear_ob_btm, i)
            array.remove(bear_ob_time, i)

// Count active Bearish OBs above current price (resistance)
ob_resistance_count = 0
if array.size(bear_ob_btm) > 0
    for i = 0 to array.size(bear_ob_btm) - 1
        ob_btm = array.get(bear_ob_btm, i)
        // Price below OB = cÃ³ cáº£n phÃ­a trÃªn
        if close < ob_btm
            ob_resistance_count := ob_resistance_count + 1

has_ob_resistance = ob_resistance_count > 0

// Draw Order Block boxes on chart
var ob_boxes = array.new_box(0)
var ob_labels = array.new_label(0)

// Clear old boxes
if barstate.isfirst or barstate.islast
    for b in ob_boxes
        box.delete(b)
    for l in ob_labels
        label.delete(l)
    array.clear(ob_boxes)
    array.clear(ob_labels)

// Draw new OB boxes
if barstate.islast and i_showOB and array.size(bear_ob_top) > 0
    for i = 0 to math.min(4, array.size(bear_ob_top) - 1)  // Max 5 OBs
        ob_top_val = array.get(bear_ob_top, i)
        ob_btm_val = array.get(bear_ob_btm, i)
        ob_time_val = array.get(bear_ob_time, i)  // Get stored OB creation time
        ob_avg_val = math.avg(ob_top_val, ob_btm_val)
        
        // Draw box starting from OB candle time
        new_box = box.new(ob_time_val, ob_top_val, time, ob_btm_val, 
              xloc=xloc.bar_time,
              border_color=color.new(#ff1100, 60), 
              bgcolor=color.new(#ff1100, 85),
              border_width=1,
              extend=extend.right,
              force_overlay=true)
        array.push(ob_boxes, new_box)
        
        // Draw label at current bar
        new_label = label.new(time, ob_avg_val, "OB", 
              xloc=xloc.bar_time,
              style=label.style_label_left,
              color=color.new(#ff1100, 70),
              textcolor=color.white,
              size=size.small,
              force_overlay=true)
        array.push(ob_labels, new_label)

// ==========================================
// 4. RSI DIVERGENCE DETECTION
// ==========================================

// Pivot detection
price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)
price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
rsi_pivot_low = ta.pivotlow(rsi_val, pivot_lookback, pivot_lookback)
rsi_pivot_high = ta.pivothigh(rsi_val, pivot_lookback, pivot_lookback)

// Store previous pivots
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// Current pivots (shifted by lookback)
curr_price_low = price_pivot_low
curr_rsi_low = rsi_pivot_low
curr_price_high = price_pivot_high
curr_rsi_high = rsi_pivot_high

// === HIDDEN BULLISH DIVERGENCE ===
// Price: Higher Low (HL) + RSI: Lower Low (LL) -> MUA LÆ¯á»šT
hidden_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_hl = low[pivot_lookback] > prev_price_low  // Price Higher Low
    rsi_ll = rsi_val[pivot_lookback] < prev_rsi_low  // RSI Lower Low
    in_oversold_zone = rsi_val[pivot_lookback] < 50  // RSI trong vÃ¹ng tháº¥p
    if price_hl and rsi_ll and in_oversold_zone
        hidden_bullish := true

// === REGULAR BULLISH DIVERGENCE ===
// Price: Lower Low (LL) + RSI: Higher Low (HL) -> Báº®T ÄÃY
regular_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_ll = low[pivot_lookback] < prev_price_low  // Price Lower Low
    rsi_hl = rsi_val[pivot_lookback] > prev_rsi_low  // RSI Higher Low
    in_oversold = rsi_val[pivot_lookback] < 40  // RSI quÃ¡ bÃ¡n
    if price_ll and rsi_hl and in_oversold
        regular_bullish := true

// === BEARISH DIVERGENCE ===
// Price: Higher High + RSI: Lower High -> Cáº¢NH BÃO BÃN
regular_bearish = false
if not na(curr_price_high) and not na(prev_price_high)
    price_hh = high[pivot_lookback] > prev_price_high
    rsi_lh = rsi_val[pivot_lookback] < prev_rsi_high
    in_overbought = rsi_val[pivot_lookback] > 60
    if price_hh and rsi_lh and in_overbought
        regular_bearish := true

// Update previous pivots
if not na(curr_price_low)
    prev_price_low := low[pivot_lookback]
    prev_rsi_low := rsi_val[pivot_lookback]
    prev_low_bar := bar_index - pivot_lookback

if not na(curr_price_high)
    prev_price_high := high[pivot_lookback]
    prev_rsi_high := rsi_val[pivot_lookback]
    prev_high_bar := bar_index - pivot_lookback

// ===== CANDLE COLORING - Äáº¬M Dáº¦N THEO BIáº¾N Äá»˜NG =====
// TÃ­nh Ä‘á»™ Ä‘áº­m (0 = Ä‘áº­m nháº¥t, 90 = nháº¡t nháº¥t)
volatility_score = math.max(vol_ratio, spread / atr_val)  // Äiá»ƒm biáº¿n Ä‘á»™ng
transparency = volatility_score >= 3.0 ? 0 :    // Biáº¿n Ä‘á»™ng cá»±c máº¡nh = Äáº­m nháº¥t
               volatility_score >= 2.0 ? 15 :   // Biáº¿n Ä‘á»™ng máº¡nh
               volatility_score >= 1.5 ? 30 :   // Biáº¿n Ä‘á»™ng khÃ¡
               volatility_score >= 1.0 ? 50 :   // BÃ¬nh thÆ°á»ng
               volatility_score >= 0.5 ? 70 :   // Yáº¿u
               85                                // Ráº¥t yáº¿u = Nháº¡t nháº¥t

// MÃ u náº¿n theo xu hÆ°á»›ng + Ä‘á»™ Ä‘áº­m theo biáº¿n Ä‘á»™ng (náº¿u báº­t)
candle_color = i_candleColoring ? (is_bullish ? color.new(color.green, transparency) : color.new(color.red, transparency)) : na

barcolor(candle_color)

// ==========================================
// 6. AUTO-SCALING & VISUALIZATION
// ==========================================
var float scaler = 0.0
stdev_cmf = ta.stdev(mf, 50)
stdev_ck = ta.stdev(ck_raw, 50)
if stdev_cmf != 0 and stdev_ck != 0
    scaler := stdev_ck / stdev_cmf
ck_visual = ck_raw / (scaler != 0 ? scaler : 1)

hline(0, "Zero", color.gray, hline.style_dotted)
plot(mf, "CMF", style=plot.style_columns, color=mf > 0 ? color.new(color.teal, 40) : color.new(color.red, 40), linewidth=3)
plot(ck_visual, "Chaikin", color=color.orange, linewidth=2)

// EMAs (Overlay)
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2, force_overlay=true)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3, force_overlay=true)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4, force_overlay=true)

// ==========================================
// 7. Cáº¢NH BÃO (CHá»ˆ ICONS QUAN TRá»ŒNG)
// ==========================================

// âš¡ VOLUME Äá»˜T BIáº¾N - Volume CAO gáº¥p 2-3 láº§n MA20 + GiÃ¡ biáº¿n Ä‘á»™ng máº¡nh
plotshape(i_volSpikeLb and is_vol_spike, "âš¡ Vol Äá»™t biáº¿n", shape.diamond, location.abovebar, color.yellow, text="âš¡", size=size.small, force_overlay=true)

// ğŸš¦ VOLUME KIá»†T - Volume tháº¥p = Háº¿t ngÆ°á»i bÃ¡n = TÃ­ch cá»±c  
plotshape(i_volDryLb and is_vol_exhaustion, "ğŸš¦ Vol Kiá»‡t", shape.circle, location.belowbar, color.lime, text="ğŸš¦", size=size.tiny, force_overlay=true)

// ==========================================
// 8. TÃN HIá»†U MUA/BÃN
// ==========================================

is_slope_up = mf > mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]
ck_cross_up = ta.crossover(ck_raw, 0)
ck_cross_down = ta.crossunder(ck_raw, 0)

// ==========================================
// KIá»‚M TRA XUNG Lá»°C HISTOGRAM (Momentum Strength)
// ==========================================
// Histogram Ä‘ang yáº¿u dáº§n = Giáº£m liÃªn tiáº¿p trong 3 phiÃªn
histogram_weakening_lookback = 3

// Kiá»ƒm tra histogram Ä‘á» yáº¿u dáº§n (Ä‘ang giáº£m Ã¢m Ä‘á»™ liÃªn tiáº¿p)
mf_negative = mf < 0
mf_weakening_count = 0
for i = 0 to histogram_weakening_lookback - 1
    if mf[i] < 0 and math.abs(mf[i]) < math.abs(mf[i+1])
        mf_weakening_count := mf_weakening_count + 1

is_histogram_red_weakening = mf_negative and mf_weakening_count >= 2  // 2/3 phiÃªn yáº¿u dáº§n

// Kiá»ƒm tra histogram xanh yáº¿u dáº§n (Ä‘ang giáº£m dÆ°Æ¡ng Ä‘á»™ liÃªn tiáº¿p)
mf_positive = mf > 0
mf_green_weakening_count = 0
for i = 0 to histogram_weakening_lookback - 1
    if mf[i] > 0 and mf[i] < mf[i+1]
        mf_green_weakening_count := mf_green_weakening_count + 1

is_histogram_green_weakening = mf_positive and mf_green_weakening_count >= 2  // 2/3 phiÃªn yáº¿u dáº§n

// Histogram Ä‘ang máº¡nh dáº§n (tÄƒng liÃªn tiáº¿p)
is_histogram_strengthening = (mf > 0 and mf > mf[1] and mf[1] > mf[2]) or (mf < 0 and math.abs(mf) > math.abs(mf[1]) and math.abs(mf[1]) > math.abs(mf[2]))

var int bars_since_sell = 100
var int bars_since_buy = 100
bars_since_sell := bars_since_sell + 1
bars_since_buy := bars_since_buy + 1

cond_cmf_ok = mf > 0 and is_slope_up
cond_ema_ok = ema_count_above >= 2
cond_vsa_ok = accumulation_sign or is_spring or is_shakeout or easy_move_up
cond_cooldown_buy = bars_since_buy >= buy_cooldown

// MUA AN TOÃ€N (MÃšC) - CHá»ˆ KHI HISTOGRAM XANH (UPTREND)
// TrÃ¡nh tÃ­n hiá»‡u khi chá»‰ lÃ  há»“i ká»¹ thuáº­t yáº¿u
histogram_green = mf > 0  // Histogram pháº£i XANH (dÃ²ng tiá»n Ä‘Ã£ vÃ o)
histogram_sufficient = mf > 0.03  // Histogram pháº£i Ä‘á»§ máº¡nh, khÃ´ng quÃ¡ yáº¿u
no_rsi_divergence = not regular_bullish[pivot_lookback] and not hidden_bullish[pivot_lookback]  // KhÃ´ng cÃ³ phÃ¢n ká»³ RSI

buy_safe = cond_cmf_ok and cond_ema_ok and ck_cross_up and cond_cooldown_buy and not is_histogram_green_weakening and histogram_green and histogram_sufficient and no_rsi_divergence

// KIM CÆ¯Æ NG ğŸ’ (MARGIN BUY) - Cá»°C Ká»² CHáº¶T CHáº¼
// Äiá»u kiá»‡n: 
// 1. Histogram xanh Máº NH (> 0.05 vÃ  Ä‘ang tÄƒng)
// 2. Chaikin Ä‘ang cáº¯t XUá»NG (khÃ´ng Ä‘Æ°á»£c á»Ÿ cao) - tá»©c Ä‘Ã£ qua Ä‘á»‰nh
// 3. VSA tÃ­ch cá»±c HOáº¶C RSI divergence
histogram_strong = mf > 0.05 and is_histogram_strengthening
chaikin_cutting_down = ck_raw < ck_raw[1] and ck_raw[1] < ck_raw[2]  // Äang giáº£m 2 phiÃªn
chaikin_not_high = ck_raw < 0.5 * ta.highest(ck_raw, 20)  // KhÃ´ng á»Ÿ 50% Ä‘á»‰nh gáº§n nháº¥t

super_buy = ((buy_safe and cond_vsa_ok and histogram_strong and (chaikin_cutting_down or chaikin_not_high)) or hidden_bullish[pivot_lookback]) and histogram_strong

if buy_safe or super_buy
    bars_since_buy := 0

// MUA Sá»šM (Sá»šM) - Histogram cÃ²n Äá» nhÆ°ng Chaikin Ä‘Ã£ cáº¯t lÃªn 0
// ÄÃ¢y lÃ  tÃ­n hiá»‡u Ä‘áº£o chiá»u sá»›m, dÃ²ng tiá»n báº¯t Ä‘áº§u vÃ o
histogram_red = mf < 0  // Histogram váº«n cÃ²n Ä‘á»
chaikin_above_zero = ck_raw > 0  // Chaikin Ä‘Ã£ vÆ°á»£t lÃªn trÃªn 0
buy_early = histogram_red and ck_cross_up and cond_cooldown_buy

if buy_early
    bars_since_buy := 0

// BÃN - CHá»ˆ KHI HISTOGRAM Äá» KHÃ”NG Yáº¾U Dáº¦N
cond_cmf_weak = mf < 0 and mf < mf[1]
cond_ema_weak = ema_count_above <= 1
cond_vsa_sell = hidden_distribution or is_upthrust
cond_cooldown_sell = bars_since_sell >= sell_cooldown

sell_sig = ((cond_cmf_weak and ck_cross_down) or cond_vsa_sell or regular_bearish[pivot_lookback]) and cond_ema_weak and cond_cooldown_sell and not is_histogram_red_weakening

if sell_sig
    bars_since_sell := 0

// ==========================================
// TÃN HIá»†U BÃN Äáº¢O CHIá»€U Báº¤T NGá»œ ğŸš¨
// ==========================================
// PhÃ¡t hiá»‡n: Histogram xanh yáº¿u dáº§n -> Ä‘á»™t ngá»™t Ä‘á» Máº NH + Chaikin cáº¯t xuá»‘ng
// ÄÃ¢y lÃ  tÃ­n hiá»‡u Ä‘áº£o chiá»u nguy hiá»ƒm cá»§a dÃ²ng tiá»n

// Kiá»ƒm tra: Histogram xanh yáº¿u trong 1-2 phiÃªn trÆ°á»›c
was_green_weakening = is_histogram_green_weakening[1] or is_histogram_green_weakening[2]

// Hiá»‡n táº¡i: Äá»™t ngá»™t chuyá»ƒn Ä‘á» Máº NH (mf < -0.05 vÃ  Ä‘ang tÄƒng Ã¢m Ä‘á»™)
sudden_red_strong = mf < -0.05 and math.abs(mf) > math.abs(mf[1])

// Chaikin cáº¯t xuá»‘ng dÆ°á»›i 0 HOáº¶C Ä‘ang giáº£m máº¡nh
chaikin_cutting_down_zero = ck_cross_down or (ck_raw < 0 and ck_raw < ck_raw[1])

// Dashboard dÃ²ng tiá»n Ä‘ang yáº¿u (MF giáº£m tá»« dÆ°Æ¡ng sang Ã¢m hoáº·c Ã¢m tÄƒng)
dashboard_weakening = (mf[1] > 0 and mf < 0) or (mf < 0 and mf < mf[1])

// TÃ­n hiá»‡u BÃN Äáº¢O CHIá»€U
sell_reversal = was_green_weakening and sudden_red_strong and chaikin_cutting_down_zero and dashboard_weakening and cond_cooldown_sell

if sell_reversal
    bars_since_sell := 0

// Cáº£nh bÃ¡o bÃ¡n (RSI overbought + bearish div)
sell_warning = rsi_overbought and regular_bearish[pivot_lookback]

// ==========================================
// 9. HIá»‚N THá»Š TÃN HIá»†U
// ==========================================
plotshape(super_buy and not super_buy[1], "Super Buy", shape.labelup, location.bottom, color.yellow, text="ğŸ’", size=size.normal)
plotshape(buy_safe and not super_buy and not buy_safe[1], "Buy Safe", shape.labelup, location.bottom, color.lime, text="MÃšC", size=size.small)
plotshape(buy_early and not buy_safe and not buy_early[1], "Buy Early", shape.triangleup, location.bottom, color.orange, text="Sá»šM", size=size.small)
plotshape(sell_sig and not sell_sig[1], "Sell", shape.labeldown, location.top, color.red, text="BÃN", size=size.small)
plotshape(sell_reversal and not sell_reversal[1], "Sell Reversal", shape.labeldown, location.top, color.maroon, text="ğŸš¨", size=size.normal)
plotshape(sell_warning and not sell_sig and not sell_warning[1] and not sell_reversal[1], "Sell Warning", shape.xcross, location.top, color.fuchsia, size=size.tiny)

// ==========================================
// 10. DASHBOARD (ÄÆ N GIáº¢N)
// ==========================================
var table panel = table.new(position.top_right, 2, 6, border_width=1, force_overlay=true)
if barstate.islast
    table.cell(panel, 0, 0, "ï¿½ TRINITY", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // DÃ²ng tiá»n
    table.cell(panel, 0, 1, "DÃ²ng tiá»n:", bgcolor=color.white, text_halign=text.align_left)
    cmf_text = mf > 0.1 ? "VÃ€O Máº NH ğŸ”¥" : mf > 0 ? "VÃ€O NHáº¸ âœ…" : mf > -0.1 ? "RA NHáº¸ âš ï¸" : "RA Máº NH âŒ"
    table.cell(panel, 1, 1, cmf_text, bgcolor=mf > 0 ? color.lime : color.red, text_color=color.white)
    
    // Trung háº¡n (EMA233) - Cáº§n 3 náº¿n liÃªn tiáº¿p Ä‘á»ƒ xÃ¡c nháº­n xu hÆ°á»›ng
    table.cell(panel, 0, 2, "Trung háº¡n:", bgcolor=color.white, text_halign=text.align_left)
    trend_text = is_confirmed_uptrend ? "UPTREND âœ…" : is_confirmed_downtrend ? "DOWNTREND âŒ" : above_ema233 ? "Äá»¢I TÃN HIá»†U â³" : "Äá»¢I TÃN HIá»†U â³"
    trend_color = is_confirmed_uptrend ? color.green : is_confirmed_downtrend ? color.red : color.orange
    table.cell(panel, 1, 2, trend_text, text_color=trend_color)
    
    // LÆ°á»›t sÃ³ng (EMA50)
    table.cell(panel, 0, 3, "LÆ°á»›t sÃ³ng:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 3, above_ema50 ? "OK âœ…" : "DÆ¯á»šI âŒ", text_color=above_ema50 ? color.green : color.red)
    
    // Cáº£n trÃªn (Order Block based)
    table.cell(panel, 0, 4, "Cáº£n trÃªn:", bgcolor=color.white, text_halign=text.align_left)
    res_text = ob_resistance_count == 0 ? "KHÃ”NG CÃ“ ğŸ†“" : ob_resistance_count == 1 ? "1 OB âš ï¸" : ob_resistance_count >= 2 ? str.tostring(ob_resistance_count) + " OB âŒ" : "Cáº¢N Máº NH âŒ"
    res_color = ob_resistance_count == 0 ? color.green : ob_resistance_count == 1 ? color.orange : color.red
    table.cell(panel, 1, 4, res_text, text_color=res_color)
    
    // Gá»£i Ã½ (Recommendation) - Cáº£i thiá»‡n logic vá»›i mua/bÃ¡n 1 pháº§n
    table.cell(panel, 0, 5, "Gá»¢I Ã:", bgcolor=color.gray, text_halign=text.align_left, text_color=color.white)
    
    // Logic gá»£i Ã½ chi tiáº¿t hÆ¡n
    rec_text = ""
    rec_bg = color.gray
    
    // Æ¯U TIÃŠN 1: DÃ²ng tiá»n ra máº¡nh nhiá»u phiÃªn â†’ BÃN Háº¾T Ä‘á»ƒ báº£o toÃ n vá»‘n
    if is_critical_outflow
        rec_text := "BÃN Háº¾T ğŸš¨"
        rec_bg := color.maroon
    // Æ¯U TIÃŠN 2: DÃ²ng tiá»n ra máº¡nh â†’ BÃN 1 PHáº¦N
    else if is_strong_outflow
        rec_text := "BÃN 1 PHáº¦N ğŸ“‰"
        rec_bg := color.red
    // Æ¯U TIÃŠN 3: Thá»‹ trÆ°á»ng choppy â†’ QUAN SÃT
    else if is_choppy_market
        rec_text := "QUAN SÃT ğŸ”„"
        rec_bg := color.gray
    // Æ¯U TIÃŠN 4: DÃ²ng tiá»n vÃ o máº¡nh 3+ phiÃªn + UPTREND â†’ MUA MARGIN (An toÃ n nháº¥t)
    else if is_critical_inflow and is_confirmed_uptrend
        rec_text := "MUA MARGIN ğŸš€"
        rec_bg := color.teal
    // Æ¯U TIÃŠN 5: DÃ²ng tiá»n vÃ o máº¡nh (3+ phiÃªn chÆ°a uptrend HOáº¶C 1 phiÃªn + uptrend) â†’ MUA Máº NH
    else if is_critical_inflow or (is_strong_inflow and is_confirmed_uptrend)
        rec_text := "MUA Máº NH ğŸ’ª"
        rec_bg := color.lime
    // Æ¯U TIÃŠN 6: DÃ²ng tiá»n vÃ o nháº¹ + (LÆ°á»›t sÃ³ng OK hoáº·c VÃ o nháº¹ 2+ phiÃªn) + giÃ¡ trÃªn EMA233 â†’ MUA 1 PHáº¦N
    else if is_light_inflow and above_ema233 and (above_ema50 or is_confirmed_light_inflow)
        rec_text := "MUA 1 PHáº¦N ğŸ‘"
        rec_bg := color.green
    // Æ¯U TIÃŠN 6: DÃ²ng tiá»n ra nháº¹ â†’ GIáº¢M Vá»Š THáº¾
    else if mf < 0 and mf >= -0.1
        rec_text := "GIáº¢M Vá»Š THáº¾ âš ï¸"
        rec_bg := color.orange
    // RSI quÃ¡ mua
    else if rsi_overbought
        rec_text := "Cáº¨N THáº¬N âš ï¸"
        rec_bg := color.orange
    // CÆ  Há»˜I MUA chá»‰ khi: dÃ²ng tiá»n vÃ o nháº¹ láº¡i + RSI divergence
    else if rsi_oversold and (regular_bullish or hidden_bullish) and mf > 0 and not is_confirmed_downtrend
        rec_text := "CÆ  Há»˜I MUA ğŸ¯"
        rec_bg := color.teal
    else
        rec_text := "QUAN SÃT ğŸ‘€"
        rec_bg := color.gray
    
    table.cell(panel, 1, 5, rec_text, bgcolor=rec_bg, text_color=color.white)

// ==========================================
// ALERTS
// ==========================================
alertcondition(super_buy, "ğŸ’ MUA Máº NH", "Super Buy - Wyckoff + RSI Confirm!")
alertcondition(hidden_bullish, "ğŸ”µ HIDDEN BULLISH", "RSI Hidden Bullish Divergence - MUA LÆ¯á»šT!")
alertcondition(regular_bullish, "ğŸŸ£ REGULAR BULLISH", "RSI Regular Bullish Divergence - Báº®T ÄÃY!")
alertcondition(regular_bearish, "ğŸ”´ BEARISH DIV", "RSI Bearish Divergence - Cáº¢NH BÃO!")
alertcondition(is_volatility_surge, "âš¡ VOLATILITY", "Volume/Price Surge Detected!")
alertcondition(sell_sig, "ğŸ”´ BÃN", "Sell Signal!")
