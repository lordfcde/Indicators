//@version=5
// Coder Stock - Money Flow Trinity Master (Wyckoff VSA + RSI Divergence)
// T√≠ch h·ª£p: CMF + Chaikin + EOM + Wyckoff VSA + RSI Divergence
// Features: Candle Coloring, Volume Climax, Shakeout, RSI Divergence, Volatility Alert
// Author: Vinh
indicator(title="CS Trinity Master VSA", shorttitle="CS_Trinity_VSA", format=format.price, precision=2, max_lines_count=100)

// ==========================================
// 1. C·∫§U H√åNH NG∆Ø·ªúI D√ôNG
// ==========================================
grp_ema = "üìà EMA Settings"
ema1_len = input.int(50, "EMA Ng·∫Øn h·∫°n (L∆∞·ªõt s√≥ng)", group=grp_ema)
ema2_len = input.int(144, "EMA Trung h·∫°n", group=grp_ema)
ema3_len = input.int(233, "EMA D√†i h·∫°n", group=grp_ema)

grp_display = "üé® Hi·ªÉn Th·ªã"
i_volSpikeLb = input.bool(true, "Hi·ªán ‚ö° Vol ƒê·ªôt bi·∫øn", group=grp_display, tooltip="Volume cao g·∫•p 2.5x MA20 + Gi√° bi·∫øn ƒë·ªông m·∫°nh")
i_volDryLb = input.bool(true, "Hi·ªán üö¶ Vol C·∫°n ki·ªát", group=grp_display, tooltip="Volume th·∫•p + Gi√° ƒëi ngang = T√≠ch l≈©y")
i_candleColoring = input.bool(true, "T√¥ m√†u n·∫øn theo bi·∫øn ƒë·ªông", group=grp_display, tooltip="N·∫øn ƒë·∫≠m = bi·∫øn ƒë·ªông m·∫°nh, n·∫øn nh·∫°t = bi·∫øn ƒë·ªông y·∫øu")
i_showOB = input.bool(true, "Hi·ªán üì¶ Order Block", group=grp_display, tooltip="Hi·ªÉn th·ªã v√πng Order Block (c·∫£n) tr√™n chart")

// ==========================================
// C√ÄI ƒê·∫∂T N·ªòI B·ªò (·∫®N)
// ==========================================
cmf_len = 20
ck_fast = 3
ck_slow = 10
eom_len = 14
eom_div = 10000
vol_climax_mult = 2.0
vol_dry_mult = 0.5
spread_narrow = 0.5
rsi_len = 14
rsi_ob = 70
rsi_os = 30
pivot_lookback = 5
sell_cooldown = 3
buy_cooldown = 3
i_volSpikeTh = 2.5
i_volDryTh = 0.3

// ==========================================
// 2. T√çNH TO√ÅN CORE
// ==========================================

// --- CMF ---
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// --- Chaikin ---
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// --- EOM ---
dm = ((high + low) / 2) - ((high[1] + low[1]) / 2)
br = (volume / eom_div) / ((high - low) != 0 ? (high - low) : 1)
eom_inst = br != 0 ? dm / br : 0
eom_raw = ta.sma(eom_inst, eom_len)

// --- EMAs (C√≥ th·ªÉ t√πy ch·ªânh) ---
ema50 = ta.ema(close, ema1_len)
ema144 = ta.ema(close, ema2_len)
ema233 = ta.ema(close, ema3_len)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
resistance_count = 3 - ema_count_above

// ƒê·∫øm s·ªë n·∫øn li√™n ti·∫øp tr√™n/d∆∞·ªõi EMA233 ƒë·ªÉ x√°c nh·∫≠n xu h∆∞·ªõng
var int candles_above_ema233 = 0
var int candles_below_ema233 = 0

if above_ema233
    candles_above_ema233 := candles_above_ema233 + 1
    candles_below_ema233 := 0
else
    candles_below_ema233 := candles_below_ema233 + 1
    candles_above_ema233 := 0

// C·∫ßn √≠t nh·∫•t 3 n·∫øn li√™n ti·∫øp ƒë·ªÉ x√°c nh·∫≠n xu h∆∞·ªõng
trend_confirm_count = 3
is_confirmed_uptrend = candles_above_ema233 >= trend_confirm_count
is_confirmed_downtrend = candles_below_ema233 >= trend_confirm_count
is_waiting_signal = not is_confirmed_uptrend and not is_confirmed_downtrend

// ƒê·∫øm s·ªë l·∫ßn ƒë·∫£o chi·ªÅu t√≠n hi·ªáu trong 10 n·∫øn g·∫ßn ƒë√¢y (ph√°t hi·ªán th·ªã tr∆∞·ªùng choppy)
signal_lookback = 10
max_flip_allowed = 3  // N·∫øu ƒë·∫£o chi·ªÅu > 3 l·∫ßn trong 10 n·∫øn = choppy

// ƒê·∫øm s·ªë l·∫ßn gi√° cross EMA233 trong lookback period
var int flip_count = 0
ema_cross = ta.cross(close, ema233)
flip_count := math.round(math.sum(ema_cross ? 1 : 0, signal_lookback))

// ƒê·∫øm s·ªë l·∫ßn d√≤ng ti·ªÅn ƒë·ªïi chi·ªÅu
mf_cross = ta.cross(mf, 0)
mf_flip_count = math.round(math.sum(mf_cross ? 1 : 0, signal_lookback))

// Th·ªã tr∆∞·ªùng choppy n·∫øu c√≥ qu√° nhi·ªÅu l·∫ßn ƒë·∫£o chi·ªÅu
is_choppy_market = flip_count > max_flip_allowed or mf_flip_count > max_flip_allowed

// --- RSI ---
rsi_val = ta.rsi(close, rsi_len)
rsi_overbought = rsi_val > rsi_ob
rsi_oversold = rsi_val < rsi_os

// ==========================================
// 3. WYCKOFF VSA ANALYSIS
// ==========================================

// --- Volume Analysis ---
vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

is_vol_climax = vol_ratio >= vol_climax_mult
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult
is_vol_normal = vol_ratio >= 0.8 and vol_ratio < 1.5
is_vol_dry = vol_ratio < vol_dry_mult

// --- Vol ƒê·ªôt bi·∫øn (Volume CAO + Gi√° bi·∫øn ƒë·ªông m·∫°nh) ---
atr_val = ta.atr(14)
spread = high - low
is_price_moving = spread > atr_val * 1.5  // Gi√° bi·∫øn ƒë·ªông m·∫°nh
is_vol_spike = vol_ratio >= i_volSpikeTh and is_price_moving  // ‚ö° Vol ƒë·ªôt bi·∫øn = Vol CAO + Gi√° ƒë·ªông

// --- Spread Analysis ---
is_spread_wide = spread > atr_val * 1.5
is_spread_narrow = spread < atr_val * spread_narrow

// --- Volume C·∫°n Ki·ªát (Dry Volume) ---
// Vol th·∫•p + Gi√° ƒëi ngang (bi√™n ƒë·ªô h·∫πp) = H·∫øt ng∆∞·ªùi b√°n, ƒëang t√≠ch l≈©y
is_vol_exhaustion = vol_ratio <= i_volDryTh and is_spread_narrow  // üö¶ T√≠n hi·ªáu t√≠ch l≈©y

// --- Candle Character ---
is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)

// --- VOLATILITY SURGE ---
// Vol ƒë·ªôt bi·∫øn HO·∫∂C Vol c·∫°n ki·ªát ƒë·ªÅu l√† t√≠n hi·ªáu quan tr·ªçng
is_volatility_surge = is_vol_spike or is_vol_exhaustion

// --- VSA Patterns ---
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish
is_spring = low < ema233 and close > ema233 and close > open
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5
easy_move_up = is_vol_dry and is_bullish and is_spread_wide

// ==========================================
// ORDER BLOCK DETECTION (Based on LuxAlgo)
// ==========================================
ob_length = 5  // Volume pivot length

// Order flow direction
var int ob_os = 0
ob_upper = ta.highest(high, ob_length)
ob_lower = ta.lowest(low, ob_length)
ob_os := high[ob_length] > ob_upper ? 0 : low[ob_length] < ob_lower ? 1 : ob_os[1]

// Volume pivot high
ob_phv = ta.pivothigh(volume, ob_length, ob_length)

// Bearish Order Block coordinates
var bear_ob_top = array.new_float(0)
var bear_ob_btm = array.new_float(0)
var bear_ob_time = array.new_int(0)  // Store creation time

// Detect new Bearish OB (Volume pivot + Downtrend)
is_bearish_ob = not na(ob_phv) and ob_os == 0
if is_bearish_ob
    array.unshift(bear_ob_top, high[ob_length])
    array.unshift(bear_ob_btm, hl2[ob_length])
    array.unshift(bear_ob_time, time[ob_length])  // Store the time of OB candle
    // Keep max 5 OBs
    if array.size(bear_ob_top) > 5
        array.pop(bear_ob_top)
        array.pop(bear_ob_btm)
        array.pop(bear_ob_time)

// Remove mitigated OBs (price > ob_top)
target_bear_ob = ta.highest(high, ob_length)
if array.size(bear_ob_top) > 0
    for i = array.size(bear_ob_top) - 1 to 0
        if i < array.size(bear_ob_top) and target_bear_ob > array.get(bear_ob_top, i)
            array.remove(bear_ob_top, i)
            array.remove(bear_ob_btm, i)
            array.remove(bear_ob_time, i)

// Count active Bearish OBs above current price (resistance)
ob_resistance_count = 0
if array.size(bear_ob_btm) > 0
    for i = 0 to array.size(bear_ob_btm) - 1
        ob_btm = array.get(bear_ob_btm, i)
        // Price below OB = c√≥ c·∫£n ph√≠a tr√™n
        if close < ob_btm
            ob_resistance_count := ob_resistance_count + 1

has_ob_resistance = ob_resistance_count > 0

// Draw Order Block boxes on chart
var ob_boxes = array.new_box(0)
var ob_labels = array.new_label(0)

// Clear old boxes
if barstate.isfirst or barstate.islast
    for b in ob_boxes
        box.delete(b)
    for l in ob_labels
        label.delete(l)
    array.clear(ob_boxes)
    array.clear(ob_labels)

// Draw new OB boxes
if barstate.islast and i_showOB and array.size(bear_ob_top) > 0
    for i = 0 to math.min(4, array.size(bear_ob_top) - 1)  // Max 5 OBs
        ob_top_val = array.get(bear_ob_top, i)
        ob_btm_val = array.get(bear_ob_btm, i)
        ob_time_val = array.get(bear_ob_time, i)  // Get stored OB creation time
        ob_avg_val = math.avg(ob_top_val, ob_btm_val)
        
        // Draw box starting from OB candle time
        new_box = box.new(ob_time_val, ob_top_val, time, ob_btm_val, 
              xloc=xloc.bar_time,
              border_color=color.new(#ff1100, 60), 
              bgcolor=color.new(#ff1100, 85),
              border_width=1,
              extend=extend.right,
              force_overlay=true)
        array.push(ob_boxes, new_box)
        
        // Draw label at current bar
        new_label = label.new(time, ob_avg_val, "OB", 
              xloc=xloc.bar_time,
              style=label.style_label_left,
              color=color.new(#ff1100, 70),
              textcolor=color.white,
              size=size.small,
              force_overlay=true)
        array.push(ob_labels, new_label)

// ==========================================
// 4. RSI DIVERGENCE DETECTION
// ==========================================

// Pivot detection
price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)
price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
rsi_pivot_low = ta.pivotlow(rsi_val, pivot_lookback, pivot_lookback)
rsi_pivot_high = ta.pivothigh(rsi_val, pivot_lookback, pivot_lookback)

// Store previous pivots
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// Current pivots (shifted by lookback)
curr_price_low = price_pivot_low
curr_rsi_low = rsi_pivot_low
curr_price_high = price_pivot_high
curr_rsi_high = rsi_pivot_high

// === HIDDEN BULLISH DIVERGENCE ===
// Price: Higher Low (HL) + RSI: Lower Low (LL) -> MUA L∆Ø·ªöT
hidden_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_hl = low[pivot_lookback] > prev_price_low  // Price Higher Low
    rsi_ll = rsi_val[pivot_lookback] < prev_rsi_low  // RSI Lower Low
    in_oversold_zone = rsi_val[pivot_lookback] < 50  // RSI trong v√πng th·∫•p
    if price_hl and rsi_ll and in_oversold_zone
        hidden_bullish := true

// === REGULAR BULLISH DIVERGENCE ===
// Price: Lower Low (LL) + RSI: Higher Low (HL) -> B·∫ÆT ƒê√ÅY
regular_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_ll = low[pivot_lookback] < prev_price_low  // Price Lower Low
    rsi_hl = rsi_val[pivot_lookback] > prev_rsi_low  // RSI Higher Low
    in_oversold = rsi_val[pivot_lookback] < 40  // RSI qu√° b√°n
    if price_ll and rsi_hl and in_oversold
        regular_bullish := true

// === BEARISH DIVERGENCE ===
// Price: Higher High + RSI: Lower High -> C·∫¢NH B√ÅO B√ÅN
regular_bearish = false
if not na(curr_price_high) and not na(prev_price_high)
    price_hh = high[pivot_lookback] > prev_price_high
    rsi_lh = rsi_val[pivot_lookback] < prev_rsi_high
    in_overbought = rsi_val[pivot_lookback] > 60
    if price_hh and rsi_lh and in_overbought
        regular_bearish := true

// Update previous pivots
if not na(curr_price_low)
    prev_price_low := low[pivot_lookback]
    prev_rsi_low := rsi_val[pivot_lookback]
    prev_low_bar := bar_index - pivot_lookback

if not na(curr_price_high)
    prev_price_high := high[pivot_lookback]
    prev_rsi_high := rsi_val[pivot_lookback]
    prev_high_bar := bar_index - pivot_lookback

// ===== CANDLE COLORING - ƒê·∫¨M D·∫¶N THEO BI·∫æN ƒê·ªòNG =====
// T√≠nh ƒë·ªô ƒë·∫≠m (0 = ƒë·∫≠m nh·∫•t, 90 = nh·∫°t nh·∫•t)
volatility_score = math.max(vol_ratio, spread / atr_val)  // ƒêi·ªÉm bi·∫øn ƒë·ªông
transparency = volatility_score >= 3.0 ? 0 :    // Bi·∫øn ƒë·ªông c·ª±c m·∫°nh = ƒê·∫≠m nh·∫•t
               volatility_score >= 2.0 ? 15 :   // Bi·∫øn ƒë·ªông m·∫°nh
               volatility_score >= 1.5 ? 30 :   // Bi·∫øn ƒë·ªông kh√°
               volatility_score >= 1.0 ? 50 :   // B√¨nh th∆∞·ªùng
               volatility_score >= 0.5 ? 70 :   // Y·∫øu
               85                                // R·∫•t y·∫øu = Nh·∫°t nh·∫•t

// M√†u n·∫øn theo xu h∆∞·ªõng + ƒë·ªô ƒë·∫≠m theo bi·∫øn ƒë·ªông (n·∫øu b·∫≠t)
candle_color = i_candleColoring ? (is_bullish ? color.new(color.green, transparency) : color.new(color.red, transparency)) : na

barcolor(candle_color)

// ==========================================
// 6. AUTO-SCALING & VISUALIZATION
// ==========================================
var float scaler = 0.0
stdev_cmf = ta.stdev(mf, 50)
stdev_ck = ta.stdev(ck_raw, 50)
if stdev_cmf != 0 and stdev_ck != 0
    scaler := stdev_ck / stdev_cmf
ck_visual = ck_raw / (scaler != 0 ? scaler : 1)

hline(0, "Zero", color.gray, hline.style_dotted)
plot(mf, "CMF", style=plot.style_columns, color=mf > 0 ? color.new(color.teal, 40) : color.new(color.red, 40), linewidth=3)
plot(ck_visual, "Chaikin", color=color.orange, linewidth=2)

// EMAs (Overlay)
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2, force_overlay=true)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3, force_overlay=true)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4, force_overlay=true)

// ==========================================
// 7. C·∫¢NH B√ÅO (CH·ªà ICONS QUAN TR·ªåNG)
// ==========================================

// ‚ö° VOLUME ƒê·ªòT BI·∫æN - Volume CAO g·∫•p 2-3 l·∫ßn MA20 + Gi√° bi·∫øn ƒë·ªông m·∫°nh
plotshape(i_volSpikeLb and is_vol_spike, "‚ö° Vol ƒê·ªôt bi·∫øn", shape.diamond, location.abovebar, color.yellow, text="‚ö°", size=size.small, force_overlay=true)

// üö¶ VOLUME KI·ªÜT - Volume th·∫•p = H·∫øt ng∆∞·ªùi b√°n = T√≠ch c·ª±c  
plotshape(i_volDryLb and is_vol_exhaustion, "üö¶ Vol Ki·ªát", shape.circle, location.belowbar, color.lime, text="üö¶", size=size.tiny, force_overlay=true)

// ==========================================
// 8. T√çN HI·ªÜU MUA/B√ÅN
// ==========================================

is_slope_up = mf > mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]
ck_cross_up = ta.crossover(ck_raw, 0)
ck_cross_down = ta.crossunder(ck_raw, 0)

var int bars_since_sell = 100
var int bars_since_buy = 100
bars_since_sell := bars_since_sell + 1
bars_since_buy := bars_since_buy + 1

cond_cmf_ok = mf > 0 and is_slope_up
cond_ema_ok = ema_count_above >= 2
cond_vsa_ok = accumulation_sign or is_spring or is_shakeout or easy_move_up
cond_cooldown_buy = bars_since_buy >= buy_cooldown

// MUA AN TO√ÄN
buy_safe = cond_cmf_ok and cond_ema_ok and ck_cross_up and cond_cooldown_buy

// MUA M·∫†NH (Wyckoff + RSI Confirm)
super_buy = (buy_safe and cond_vsa_ok) or hidden_bullish[pivot_lookback]

if buy_safe or super_buy
    bars_since_buy := 0

// MUA S·ªöM (RSI Divergence / Spring)
buy_early = ((is_spring or is_shakeout or accumulation_sign) and cmf_recovering and cond_cooldown_buy) or regular_bullish[pivot_lookback]

if buy_early
    bars_since_buy := 0

// B√ÅN
cond_cmf_weak = mf < 0 and mf < mf[1]
cond_ema_weak = ema_count_above <= 1
cond_vsa_sell = hidden_distribution or is_upthrust
cond_cooldown_sell = bars_since_sell >= sell_cooldown

sell_sig = ((cond_cmf_weak and ck_cross_down) or cond_vsa_sell or regular_bearish[pivot_lookback]) and cond_ema_weak and cond_cooldown_sell

if sell_sig
    bars_since_sell := 0

// C·∫£nh b√°o b√°n (RSI overbought + bearish div)
sell_warning = rsi_overbought and regular_bearish[pivot_lookback]

// ==========================================
// 9. HI·ªÇN TH·ªä T√çN HI·ªÜU
// ==========================================
plotshape(super_buy and not super_buy[1], "Super Buy", shape.labelup, location.bottom, color.yellow, text="üíé", size=size.normal)
plotshape(buy_safe and not super_buy and not buy_safe[1], "Buy Safe", shape.labelup, location.bottom, color.lime, text="M√öC", size=size.small)
plotshape(buy_early and not buy_safe and not buy_early[1], "Buy Early", shape.triangleup, location.bottom, color.orange, text="S·ªöM", size=size.small)
plotshape(sell_sig and not sell_sig[1], "Sell", shape.labeldown, location.top, color.red, text="B√ÅN", size=size.small)
plotshape(sell_warning and not sell_sig and not sell_warning[1], "Sell Warning", shape.xcross, location.top, color.fuchsia, size=size.tiny)

// ==========================================
// 10. DASHBOARD (ƒê∆†N GI·∫¢N)
// ==========================================
var table panel = table.new(position.top_right, 2, 6, border_width=1, force_overlay=true)
if barstate.islast
    table.cell(panel, 0, 0, "ÔøΩ TRINITY", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // D√≤ng ti·ªÅn
    table.cell(panel, 0, 1, "D√≤ng ti·ªÅn:", bgcolor=color.white, text_halign=text.align_left)
    cmf_text = mf > 0.1 ? "V√ÄO M·∫†NH üî•" : mf > 0 ? "V√ÄO NH·∫∏ ‚úÖ" : mf > -0.1 ? "RA NH·∫∏ ‚ö†Ô∏è" : "RA M·∫†NH ‚ùå"
    table.cell(panel, 1, 1, cmf_text, bgcolor=mf > 0 ? color.lime : color.red, text_color=color.white)
    
    // Trung h·∫°n (EMA233) - C·∫ßn 3 n·∫øn li√™n ti·∫øp ƒë·ªÉ x√°c nh·∫≠n xu h∆∞·ªõng
    table.cell(panel, 0, 2, "Trung h·∫°n:", bgcolor=color.white, text_halign=text.align_left)
    trend_text = is_confirmed_uptrend ? "UPTREND ‚úÖ" : is_confirmed_downtrend ? "DOWNTREND ‚ùå" : above_ema233 ? "ƒê·ª¢I T√çN HI·ªÜU ‚è≥" : "ƒê·ª¢I T√çN HI·ªÜU ‚è≥"
    trend_color = is_confirmed_uptrend ? color.green : is_confirmed_downtrend ? color.red : color.orange
    table.cell(panel, 1, 2, trend_text, text_color=trend_color)
    
    // L∆∞·ªõt s√≥ng (EMA50)
    table.cell(panel, 0, 3, "L∆∞·ªõt s√≥ng:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 3, above_ema50 ? "OK ‚úÖ" : "D∆Ø·ªöI ‚ùå", text_color=above_ema50 ? color.green : color.red)
    
    // C·∫£n tr√™n (Order Block based)
    table.cell(panel, 0, 4, "C·∫£n tr√™n:", bgcolor=color.white, text_halign=text.align_left)
    res_text = ob_resistance_count == 0 ? "KH√îNG C√ì üÜì" : ob_resistance_count == 1 ? "1 OB ‚ö†Ô∏è" : ob_resistance_count >= 2 ? str.tostring(ob_resistance_count) + " OB ‚ùå" : "C·∫¢N M·∫†NH ‚ùå"
    res_color = ob_resistance_count == 0 ? color.green : ob_resistance_count == 1 ? color.orange : color.red
    table.cell(panel, 1, 4, res_text, text_color=res_color)
    
    // G·ª£i √Ω (Recommendation) - C·∫£i thi·ªán logic v·ªõi mua/b√°n 1 ph·∫ßn
    table.cell(panel, 0, 5, "G·ª¢I √ù:", bgcolor=color.gray, text_halign=text.align_left, text_color=color.white)
    
    // Logic g·ª£i √Ω chi ti·∫øt h∆°n
    rec_text = ""
    rec_bg = color.gray
    
    // Ki·ªÉm tra th·ªã tr∆∞·ªùng choppy tr∆∞·ªõc
    if is_choppy_market
        rec_text := "QUAN S√ÅT üîÑ"
        rec_bg := color.gray
    else if mf > 0.1 and is_confirmed_uptrend
        rec_text := "MUA M·∫†NH üí™"
        rec_bg := color.lime
    else if mf > 0 and mf <= 0.1 and above_ema233
        rec_text := "MUA 1 PH·∫¶N üëç"
        rec_bg := color.green
    else if mf < -0.1 and is_confirmed_downtrend
        rec_text := "B√ÅN üëã"
        rec_bg := color.red
    else if mf < 0 and mf >= -0.1 and not above_ema233
        rec_text := "B√ÅN 1 PH·∫¶N ‚ö†Ô∏è"
        rec_bg := color.orange
    else if rsi_overbought
        rec_text := "C·∫®N TH·∫¨N ‚ö†Ô∏è"
        rec_bg := color.orange
    else if rsi_oversold and above_ema233
        rec_text := "C∆† H·ªòI MUA üéØ"
        rec_bg := color.teal
    else
        rec_text := "QUAN S√ÅT üëÄ"
        rec_bg := color.gray
    
    table.cell(panel, 1, 5, rec_text, bgcolor=rec_bg, text_color=color.white)

// ==========================================
// ALERTS
// ==========================================
alertcondition(super_buy, "üíé MUA M·∫†NH", "Super Buy - Wyckoff + RSI Confirm!")
alertcondition(hidden_bullish, "üîµ HIDDEN BULLISH", "RSI Hidden Bullish Divergence - MUA L∆Ø·ªöT!")
alertcondition(regular_bullish, "üü£ REGULAR BULLISH", "RSI Regular Bullish Divergence - B·∫ÆT ƒê√ÅY!")
alertcondition(regular_bearish, "üî¥ BEARISH DIV", "RSI Bearish Divergence - C·∫¢NH B√ÅO!")
alertcondition(is_volatility_surge, "‚ö° VOLATILITY", "Volume/Price Surge Detected!")
alertcondition(sell_sig, "üî¥ B√ÅN", "Sell Signal!")
