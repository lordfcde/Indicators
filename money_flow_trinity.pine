//@version=5
// Coder Stock - Money Flow Trinity Master (Wyckoff VSA + RSI Divergence)
// T√≠ch h·ª£p: CMF + Chaikin + EOM + Wyckoff VSA + RSI Divergence
// Features: Candle Coloring, Volume Climax, Shakeout, RSI Divergence, Volatility Alert
// Author: Vinh
indicator(title="CS Trinity Master VSA", shorttitle="CS_Trinity_VSA", format=format.price, precision=2, max_lines_count=100)

// ==========================================
// 1. C·∫§U H√åNH
// ==========================================
grp_cmf = "1. CMF (D√≤ng Ti·ªÅn)"
cmf_len = input.int(20, "CMF Length", group=grp_cmf)

grp_ck = "2. Chaikin Oscillator"
ck_fast = input.int(3, "Fast", group=grp_ck)
ck_slow = input.int(10, "Slow", group=grp_ck)

grp_eom = "3. EOM"
eom_len = input.int(14, "Length", group=grp_eom)
eom_div = input.int(10000, "Divisor", group=grp_eom)

grp_vsa = "4. Wyckoff VSA"
vol_climax_mult = input.float(2.0, "Volume Climax (x TB)", group=grp_vsa)
vol_dry_mult = input.float(0.5, "Volume C·∫°n (x TB)", group=grp_vsa)
spread_narrow = input.float(0.5, "Spread H·∫πp (x ATR)", group=grp_vsa)

grp_rsi = "5. RSI Divergence"
rsi_len = input.int(14, "RSI Length", group=grp_rsi)
rsi_ob = input.int(70, "Overbought", group=grp_rsi)
rsi_os = input.int(30, "Oversold", group=grp_rsi)
pivot_lookback = input.int(5, "Pivot Lookback", group=grp_rsi)

grp_cooldown = "6. Ch·ªëng Nhi·ªÖu"
sell_cooldown = input.int(3, "Cooldown B√ÅN", minval=1, group=grp_cooldown)
buy_cooldown = input.int(3, "Cooldown MUA", minval=1, group=grp_cooldown)

grp_addon = "7. C·∫£nh B√°o ƒê·∫∑c Bi·ªát"
i_volSpikeLb = input.bool(true, "Hi·ªán ‚ö° (Vol ƒê·ªôt bi·∫øn)", group=grp_addon)
i_volSpikeTh = input.float(2.5, "Ng∆∞·ª°ng Vol ƒê·ªôt bi·∫øn (x MA20)", group=grp_addon, tooltip="Volume > X l·∫ßn MA20 = ƒê·ªôt bi·∫øn")
i_volDryLb = input.bool(true, "Hi·ªán üö¶ (Vol Ki·ªát)", group=grp_addon)
i_volDryTh = input.float(0.3, "Ng∆∞·ª°ng Vol Ki·ªát (x MA20)", group=grp_addon, tooltip="Volume < X l·∫ßn MA20 = C·∫°n ki·ªát")

// ==========================================
// 2. T√çNH TO√ÅN CORE
// ==========================================

// --- CMF ---
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// --- Chaikin ---
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// --- EOM ---
dm = ((high + low) / 2) - ((high[1] + low[1]) / 2)
br = (volume / eom_div) / ((high - low) != 0 ? (high - low) : 1)
eom_inst = br != 0 ? dm / br : 0
eom_raw = ta.sma(eom_inst, eom_len)

// --- EMAs ---
ema50 = ta.ema(close, 50)
ema144 = ta.ema(close, 144)
ema233 = ta.ema(close, 233)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
resistance_count = 3 - ema_count_above

// --- RSI ---
rsi_val = ta.rsi(close, rsi_len)
rsi_overbought = rsi_val > rsi_ob
rsi_oversold = rsi_val < rsi_os

// ==========================================
// 3. WYCKOFF VSA ANALYSIS
// ==========================================

// --- Volume Analysis ---
vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

is_vol_climax = vol_ratio >= vol_climax_mult
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult
is_vol_normal = vol_ratio >= 0.8 and vol_ratio < 1.5
is_vol_dry = vol_ratio < vol_dry_mult

// --- Vol ƒê·ªôt bi·∫øn (Volume CAO + Gi√° bi·∫øn ƒë·ªông m·∫°nh) ---
atr_val = ta.atr(14)
spread = high - low
is_price_moving = spread > atr_val * 1.5  // Gi√° bi·∫øn ƒë·ªông m·∫°nh
is_vol_spike = vol_ratio >= i_volSpikeTh and is_price_moving  // ‚ö° Vol ƒë·ªôt bi·∫øn = Vol CAO + Gi√° ƒë·ªông

// --- Spread Analysis ---
is_spread_wide = spread > atr_val * 1.5
is_spread_narrow = spread < atr_val * spread_narrow

// --- Volume C·∫°n Ki·ªát (Dry Volume) ---
// Vol th·∫•p + Gi√° ƒëi ngang (bi√™n ƒë·ªô h·∫πp) = H·∫øt ng∆∞·ªùi b√°n, ƒëang t√≠ch l≈©y
is_vol_exhaustion = vol_ratio <= i_volDryTh and is_spread_narrow  // üö¶ T√≠n hi·ªáu t√≠ch l≈©y

// --- Candle Character ---
is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)

// --- VOLATILITY SURGE ---
// Vol ƒë·ªôt bi·∫øn HO·∫∂C Vol c·∫°n ki·ªát ƒë·ªÅu l√† t√≠n hi·ªáu quan tr·ªçng
is_volatility_surge = is_vol_spike or is_vol_exhaustion

// --- VSA Patterns ---
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish
is_spring = low < ema233 and close > ema233 and close > open
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5
easy_move_up = is_vol_dry and is_bullish and is_spread_wide

// ==========================================
// 4. RSI DIVERGENCE DETECTION
// ==========================================

// Pivot detection
price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)
price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
rsi_pivot_low = ta.pivotlow(rsi_val, pivot_lookback, pivot_lookback)
rsi_pivot_high = ta.pivothigh(rsi_val, pivot_lookback, pivot_lookback)

// Store previous pivots
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// Current pivots (shifted by lookback)
curr_price_low = price_pivot_low
curr_rsi_low = rsi_pivot_low
curr_price_high = price_pivot_high
curr_rsi_high = rsi_pivot_high

// === HIDDEN BULLISH DIVERGENCE ===
// Price: Higher Low (HL) + RSI: Lower Low (LL) -> MUA L∆Ø·ªöT
hidden_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_hl = low[pivot_lookback] > prev_price_low  // Price Higher Low
    rsi_ll = rsi_val[pivot_lookback] < prev_rsi_low  // RSI Lower Low
    in_oversold_zone = rsi_val[pivot_lookback] < 50  // RSI trong v√πng th·∫•p
    if price_hl and rsi_ll and in_oversold_zone
        hidden_bullish := true

// === REGULAR BULLISH DIVERGENCE ===
// Price: Lower Low (LL) + RSI: Higher Low (HL) -> B·∫ÆT ƒê√ÅY
regular_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_ll = low[pivot_lookback] < prev_price_low  // Price Lower Low
    rsi_hl = rsi_val[pivot_lookback] > prev_rsi_low  // RSI Higher Low
    in_oversold = rsi_val[pivot_lookback] < 40  // RSI qu√° b√°n
    if price_ll and rsi_hl and in_oversold
        regular_bullish := true

// === BEARISH DIVERGENCE ===
// Price: Higher High + RSI: Lower High -> C·∫¢NH B√ÅO B√ÅN
regular_bearish = false
if not na(curr_price_high) and not na(prev_price_high)
    price_hh = high[pivot_lookback] > prev_price_high
    rsi_lh = rsi_val[pivot_lookback] < prev_rsi_high
    in_overbought = rsi_val[pivot_lookback] > 60
    if price_hh and rsi_lh and in_overbought
        regular_bearish := true

// Update previous pivots
if not na(curr_price_low)
    prev_price_low := low[pivot_lookback]
    prev_rsi_low := rsi_val[pivot_lookback]
    prev_low_bar := bar_index - pivot_lookback

if not na(curr_price_high)
    prev_price_high := high[pivot_lookback]
    prev_rsi_high := rsi_val[pivot_lookback]
    prev_high_bar := bar_index - pivot_lookback

// ===== CANDLE COLORING - ƒê·∫¨M D·∫¶N THEO BI·∫æN ƒê·ªòNG =====
// T√≠nh ƒë·ªô ƒë·∫≠m (0 = ƒë·∫≠m nh·∫•t, 90 = nh·∫°t nh·∫•t)
volatility_score = math.max(vol_ratio, spread / atr_val)  // ƒêi·ªÉm bi·∫øn ƒë·ªông
transparency = volatility_score >= 3.0 ? 0 :    // Bi·∫øn ƒë·ªông c·ª±c m·∫°nh = ƒê·∫≠m nh·∫•t
               volatility_score >= 2.0 ? 15 :   // Bi·∫øn ƒë·ªông m·∫°nh
               volatility_score >= 1.5 ? 30 :   // Bi·∫øn ƒë·ªông kh√°
               volatility_score >= 1.0 ? 50 :   // B√¨nh th∆∞·ªùng
               volatility_score >= 0.5 ? 70 :   // Y·∫øu
               85                                // R·∫•t y·∫øu = Nh·∫°t nh·∫•t

// M√†u n·∫øn theo xu h∆∞·ªõng + ƒë·ªô ƒë·∫≠m theo bi·∫øn ƒë·ªông
candle_color = is_bullish ? color.new(color.green, transparency) : color.new(color.red, transparency)

barcolor(candle_color)

// ==========================================
// 6. AUTO-SCALING & VISUALIZATION
// ==========================================
var float scaler = 0.0
stdev_cmf = ta.stdev(mf, 50)
stdev_ck = ta.stdev(ck_raw, 50)
if stdev_cmf != 0 and stdev_ck != 0
    scaler := stdev_ck / stdev_cmf
ck_visual = ck_raw / (scaler != 0 ? scaler : 1)

hline(0, "Zero", color.gray, hline.style_dotted)
plot(mf, "CMF", style=plot.style_columns, color=mf > 0 ? color.new(color.teal, 40) : color.new(color.red, 40), linewidth=3)
plot(ck_visual, "Chaikin", color=color.orange, linewidth=2)

// EMAs (Overlay)
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2, force_overlay=true)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3, force_overlay=true)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4, force_overlay=true)

// ==========================================
// 7. C·∫¢NH B√ÅO (CH·ªà ICONS QUAN TR·ªåNG)
// ==========================================

// ‚ö° VOLUME ƒê·ªòT BI·∫æN - Volume CAO g·∫•p 2-3 l·∫ßn MA20 + Gi√° bi·∫øn ƒë·ªông m·∫°nh
plotshape(i_volSpikeLb and is_vol_spike, "‚ö° Vol ƒê·ªôt bi·∫øn", shape.diamond, location.abovebar, color.yellow, text="‚ö°", size=size.small, force_overlay=true)

// üö¶ VOLUME KI·ªÜT - Volume th·∫•p = H·∫øt ng∆∞·ªùi b√°n = T√≠ch c·ª±c  
plotshape(i_volDryLb and is_vol_exhaustion, "üö¶ Vol Ki·ªát", shape.circle, location.belowbar, color.lime, text="üö¶", size=size.tiny, force_overlay=true)

// ==========================================
// 8. T√çN HI·ªÜU MUA/B√ÅN
// ==========================================

is_slope_up = mf > mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]
ck_cross_up = ta.crossover(ck_raw, 0)
ck_cross_down = ta.crossunder(ck_raw, 0)

var int bars_since_sell = 100
var int bars_since_buy = 100
bars_since_sell := bars_since_sell + 1
bars_since_buy := bars_since_buy + 1

cond_cmf_ok = mf > 0 and is_slope_up
cond_ema_ok = ema_count_above >= 2
cond_vsa_ok = accumulation_sign or is_spring or is_shakeout or easy_move_up
cond_cooldown_buy = bars_since_buy >= buy_cooldown

// MUA AN TO√ÄN
buy_safe = cond_cmf_ok and cond_ema_ok and ck_cross_up and cond_cooldown_buy

// MUA M·∫†NH (Wyckoff + RSI Confirm)
super_buy = (buy_safe and cond_vsa_ok) or hidden_bullish[pivot_lookback]

if buy_safe or super_buy
    bars_since_buy := 0

// MUA S·ªöM (RSI Divergence / Spring)
buy_early = ((is_spring or is_shakeout or accumulation_sign) and cmf_recovering and cond_cooldown_buy) or regular_bullish[pivot_lookback]

if buy_early
    bars_since_buy := 0

// B√ÅN
cond_cmf_weak = mf < 0 and mf < mf[1]
cond_ema_weak = ema_count_above <= 1
cond_vsa_sell = hidden_distribution or is_upthrust
cond_cooldown_sell = bars_since_sell >= sell_cooldown

sell_sig = ((cond_cmf_weak and ck_cross_down) or cond_vsa_sell or regular_bearish[pivot_lookback]) and cond_ema_weak and cond_cooldown_sell

if sell_sig
    bars_since_sell := 0

// C·∫£nh b√°o b√°n (RSI overbought + bearish div)
sell_warning = rsi_overbought and regular_bearish[pivot_lookback]

// ==========================================
// 9. HI·ªÇN TH·ªä T√çN HI·ªÜU
// ==========================================
plotshape(super_buy and not super_buy[1], "Super Buy", shape.labelup, location.bottom, color.yellow, text="üíé", size=size.normal)
plotshape(buy_safe and not super_buy and not buy_safe[1], "Buy Safe", shape.labelup, location.bottom, color.lime, text="M√öC", size=size.small)
plotshape(buy_early and not buy_safe and not buy_early[1], "Buy Early", shape.triangleup, location.bottom, color.orange, text="S·ªöM", size=size.small)
plotshape(sell_sig and not sell_sig[1], "Sell", shape.labeldown, location.top, color.red, text="B√ÅN", size=size.small)
plotshape(sell_warning and not sell_sig and not sell_warning[1], "Sell Warning", shape.xcross, location.top, color.fuchsia, size=size.tiny)

// ==========================================
// 10. DASHBOARD (ƒê∆†N GI·∫¢N)
// ==========================================
var table panel = table.new(position.top_right, 2, 6, border_width=1, force_overlay=true)
if barstate.islast
    table.cell(panel, 0, 0, "ÔøΩ TRINITY", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // D√≤ng ti·ªÅn
    table.cell(panel, 0, 1, "D√≤ng ti·ªÅn:", bgcolor=color.white, text_halign=text.align_left)
    cmf_text = mf > 0.1 ? "V√ÄO M·∫†NH üî•" : mf > 0 ? "V√ÄO NH·∫∏ ‚úÖ" : mf > -0.1 ? "RA NH·∫∏ ‚ö†Ô∏è" : "RA M·∫†NH ‚ùå"
    table.cell(panel, 1, 1, cmf_text, bgcolor=mf > 0 ? color.lime : color.red, text_color=color.white)
    
    // Trung h·∫°n (EMA233)
    table.cell(panel, 0, 2, "Trung h·∫°n:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 2, above_ema233 ? "UPTREND ‚úÖ" : "DOWNTREND ‚ùå", text_color=above_ema233 ? color.green : color.red)
    
    // L∆∞·ªõt s√≥ng (EMA50)
    table.cell(panel, 0, 3, "L∆∞·ªõt s√≥ng:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 3, above_ema50 ? "OK ‚úÖ" : "D∆Ø·ªöI ‚ùå", text_color=above_ema50 ? color.green : color.red)
    
    // C·∫£n tr√™n
    table.cell(panel, 0, 4, "C·∫£n tr√™n:", bgcolor=color.white, text_halign=text.align_left)
    res_text = resistance_count == 0 ? "KH√îNG C√ì ÔøΩ" : resistance_count == 1 ? "1 C·∫¢N ‚ö†Ô∏è" : resistance_count == 2 ? "2 C·∫¢N ÔøΩ" : "3 C·∫¢N ‚ùå"
    res_color = resistance_count == 0 ? color.green : resistance_count <= 1 ? color.orange : color.red
    table.cell(panel, 1, 4, res_text, text_color=res_color)
    
    // G·ª£i √Ω (Recommendation)
    table.cell(panel, 0, 5, "G·ª¢I √ù:", bgcolor=color.gray, text_halign=text.align_left, text_color=color.white)
    rec_text = ema_count_above == 3 and mf > 0 ? "MUA M·∫†NH üí™" : ema_count_above >= 2 and mf > 0 ? "MUA üëç" : rsi_overbought ? "C·∫®N TH·∫¨N ‚ö†Ô∏è" : mf < 0 and ema_count_above <= 1 ? "B√ÅN üëã" : "QUAN S√ÅT üëÄ"
    rec_bg = ema_count_above == 3 and mf > 0 ? color.lime : ema_count_above >= 2 and mf > 0 ? color.green : rsi_overbought ? color.orange : mf < 0 and ema_count_above <= 1 ? color.red : color.gray
    table.cell(panel, 1, 5, rec_text, bgcolor=rec_bg, text_color=color.white)

// ==========================================
// ALERTS
// ==========================================
alertcondition(super_buy, "üíé MUA M·∫†NH", "Super Buy - Wyckoff + RSI Confirm!")
alertcondition(hidden_bullish, "üîµ HIDDEN BULLISH", "RSI Hidden Bullish Divergence - MUA L∆Ø·ªöT!")
alertcondition(regular_bullish, "üü£ REGULAR BULLISH", "RSI Regular Bullish Divergence - B·∫ÆT ƒê√ÅY!")
alertcondition(regular_bearish, "üî¥ BEARISH DIV", "RSI Bearish Divergence - C·∫¢NH B√ÅO!")
alertcondition(is_volatility_surge, "‚ö° VOLATILITY", "Volume/Price Surge Detected!")
alertcondition(sell_sig, "üî¥ B√ÅN", "Sell Signal!")
