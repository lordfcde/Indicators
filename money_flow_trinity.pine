//@version=5
// Coder Stock - Money Flow Trinity Master (Wyckoff VSA + RSI Divergence)
// T√≠ch h·ª£p: CMF + Chaikin + EOM + Wyckoff VSA + RSI Divergence
// Features: Candle Coloring, Volume Climax, Shakeout, RSI Divergence, Volatility Alert
// Author: Vinh
indicator(title="CS Trinity Master VSA", shorttitle="CS_Trinity_VSA", format=format.price, precision=2, max_lines_count=100)

// ==========================================
// 1. C·∫§U H√åNH
// ==========================================
grp_cmf = "1. CMF (D√≤ng Ti·ªÅn)"
cmf_len = input.int(20, "CMF Length", group=grp_cmf)

grp_ck = "2. Chaikin Oscillator"
ck_fast = input.int(3, "Fast", group=grp_ck)
ck_slow = input.int(10, "Slow", group=grp_ck)

grp_eom = "3. EOM"
eom_len = input.int(14, "Length", group=grp_eom)
eom_div = input.int(10000, "Divisor", group=grp_eom)

grp_vsa = "4. Wyckoff VSA"
vol_climax_mult = input.float(2.0, "Volume Climax (x TB)", group=grp_vsa)
vol_dry_mult = input.float(0.5, "Volume C·∫°n (x TB)", group=grp_vsa)
spread_narrow = input.float(0.5, "Spread H·∫πp (x ATR)", group=grp_vsa)

grp_rsi = "5. RSI Divergence"
rsi_len = input.int(14, "RSI Length", group=grp_rsi)
rsi_ob = input.int(70, "Overbought", group=grp_rsi)
rsi_os = input.int(30, "Oversold", group=grp_rsi)
pivot_lookback = input.int(5, "Pivot Lookback", group=grp_rsi)

grp_cooldown = "6. Ch·ªëng Nhi·ªÖu"
sell_cooldown = input.int(3, "Cooldown B√ÅN", minval=1, group=grp_cooldown)
buy_cooldown = input.int(3, "Cooldown MUA", minval=1, group=grp_cooldown)

grp_addon = "7. C·∫£nh B√°o ƒê·∫∑c Bi·ªát"
i_vSpikeLb = input.bool(true, "Hi·ªán üö¶ (Vol Ki·ªát s·ª©c)", group=grp_addon)
i_vSpikeTh = input.float(4.669, "Ng∆∞·ª°ng Vol Ki·ªát s·ª©c (x TB)", group=grp_addon, tooltip="Volume > X l·∫ßn TB = Ki·ªát s·ª©c")
i_hATRLb = input.bool(true, "Hi·ªán ‚ö° (Bi·∫øn ƒë·ªông l·ªèng l·∫ªo)", group=grp_addon)
i_atr_mult = input.float(2.718, "Ng∆∞·ª°ng Bi·∫øn ƒë·ªông (x ATR)", group=grp_addon, tooltip="Spread > X l·∫ßn ATR = Bi·∫øn ƒë·ªông m·∫°nh")

// ==========================================
// 2. T√çNH TO√ÅN CORE
// ==========================================

// --- CMF ---
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// --- Chaikin ---
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// --- EOM ---
dm = ((high + low) / 2) - ((high[1] + low[1]) / 2)
br = (volume / eom_div) / ((high - low) != 0 ? (high - low) : 1)
eom_inst = br != 0 ? dm / br : 0
eom_raw = ta.sma(eom_inst, eom_len)

// --- EMAs ---
ema50 = ta.ema(close, 50)
ema144 = ta.ema(close, 144)
ema233 = ta.ema(close, 233)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
resistance_count = 3 - ema_count_above

// --- RSI ---
rsi_val = ta.rsi(close, rsi_len)
rsi_overbought = rsi_val > rsi_ob
rsi_oversold = rsi_val < rsi_os

// ==========================================
// 3. WYCKOFF VSA ANALYSIS
// ==========================================

// --- Volume Analysis ---
vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

is_vol_climax = vol_ratio >= vol_climax_mult
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult
is_vol_normal = vol_ratio >= 0.8 and vol_ratio < 1.5
is_vol_dry = vol_ratio < vol_dry_mult

// --- Volume Ki·ªát s·ª©c (Exhaustion) ---
is_vol_exhaustion = vol_ratio >= i_vSpikeTh  // üö¶ Volume c·ª±c ƒë·∫°i

// --- Spread Analysis ---
atr_val = ta.atr(14)
spread = high - low
is_spread_wide = spread > atr_val * 1.5
is_spread_narrow = spread < atr_val * spread_narrow

// --- Candle Character ---
is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)

// --- VOLATILITY SURGE (Bi·∫øn ƒë·ªông m·∫°nh) ---
// Bi·∫øn ƒë·ªông l·ªèng l·∫ªo theo ATR
is_high_volatility = spread > atr_val * i_atr_mult  // ‚ö° Bi·∫øn ƒë·ªông m·∫°nh
is_volatility_surge = is_vol_exhaustion or is_high_volatility

// --- VSA Patterns ---
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish
is_spring = low < ema233 and close > ema233 and close > open
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5
easy_move_up = is_vol_dry and is_bullish and is_spread_wide

// ==========================================
// 4. RSI DIVERGENCE DETECTION
// ==========================================

// Pivot detection
price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)
price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
rsi_pivot_low = ta.pivotlow(rsi_val, pivot_lookback, pivot_lookback)
rsi_pivot_high = ta.pivothigh(rsi_val, pivot_lookback, pivot_lookback)

// Store previous pivots
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// Current pivots (shifted by lookback)
curr_price_low = price_pivot_low
curr_rsi_low = rsi_pivot_low
curr_price_high = price_pivot_high
curr_rsi_high = rsi_pivot_high

// === HIDDEN BULLISH DIVERGENCE ===
// Price: Higher Low (HL) + RSI: Lower Low (LL) -> MUA L∆Ø·ªöT
hidden_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_hl = low[pivot_lookback] > prev_price_low  // Price Higher Low
    rsi_ll = rsi_val[pivot_lookback] < prev_rsi_low  // RSI Lower Low
    in_oversold_zone = rsi_val[pivot_lookback] < 50  // RSI trong v√πng th·∫•p
    if price_hl and rsi_ll and in_oversold_zone
        hidden_bullish := true

// === REGULAR BULLISH DIVERGENCE ===
// Price: Lower Low (LL) + RSI: Higher Low (HL) -> B·∫ÆT ƒê√ÅY
regular_bullish = false
if not na(curr_price_low) and not na(prev_price_low)
    price_ll = low[pivot_lookback] < prev_price_low  // Price Lower Low
    rsi_hl = rsi_val[pivot_lookback] > prev_rsi_low  // RSI Higher Low
    in_oversold = rsi_val[pivot_lookback] < 40  // RSI qu√° b√°n
    if price_ll and rsi_hl and in_oversold
        regular_bullish := true

// === BEARISH DIVERGENCE ===
// Price: Higher High + RSI: Lower High -> C·∫¢NH B√ÅO B√ÅN
regular_bearish = false
if not na(curr_price_high) and not na(prev_price_high)
    price_hh = high[pivot_lookback] > prev_price_high
    rsi_lh = rsi_val[pivot_lookback] < prev_rsi_high
    in_overbought = rsi_val[pivot_lookback] > 60
    if price_hh and rsi_lh and in_overbought
        regular_bearish := true

// Update previous pivots
if not na(curr_price_low)
    prev_price_low := low[pivot_lookback]
    prev_rsi_low := rsi_val[pivot_lookback]
    prev_low_bar := bar_index - pivot_lookback

if not na(curr_price_high)
    prev_price_high := high[pivot_lookback]
    prev_rsi_high := rsi_val[pivot_lookback]
    prev_high_bar := bar_index - pivot_lookback

// ==========================================
// 5. CANDLE COLORING
// ==========================================

// N·∫øn VOLATILITY SURGE = Vi·ªÅn ƒë·∫≠m (d√πng m√†u ƒë·∫∑c bi·ªát)
candle_color = is_volatility_surge and is_bullish ? color.new(color.yellow, 0) :  // V√†ng ƒë·∫≠m - Ti·ªÅn m·∫°nh
               is_volatility_surge and is_bearish ? color.new(color.fuchsia, 0) :  // T√≠m ƒë·∫≠m - Bi·∫øn ƒë·ªông m·∫°nh
               is_vol_climax and is_bullish and close_position > 0.6 ? color.yellow :
               is_vol_climax and is_bearish and close_position > 0.6 ? color.aqua :
               is_vol_high and is_bullish ? color.teal :
               is_vol_high and is_bearish ? color.maroon :
               is_vol_dry ? color.gray :
               is_bullish ? color.green : color.red

barcolor(candle_color)

// ==========================================
// 6. AUTO-SCALING & VISUALIZATION
// ==========================================
var float scaler = 0.0
stdev_cmf = ta.stdev(mf, 50)
stdev_ck = ta.stdev(ck_raw, 50)
if stdev_cmf != 0 and stdev_ck != 0
    scaler := stdev_ck / stdev_cmf
ck_visual = ck_raw / (scaler != 0 ? scaler : 1)

hline(0, "Zero", color.gray, hline.style_dotted)
plot(mf, "CMF", style=plot.style_columns, color=mf > 0 ? color.new(color.teal, 40) : color.new(color.red, 40), linewidth=3)
plot(ck_visual, "Chaikin", color=color.orange, linewidth=2)

// EMAs (Overlay)
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2, force_overlay=true)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3, force_overlay=true)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4, force_overlay=true)

// ==========================================
// 7. WARNING ICONS
// ==========================================

// üö¶ VOLUME KI·ªÜT S·ª®C (Exhaustion) - Ch·ªâ khi b·∫≠t v√† Vol > ng∆∞·ª°ng
plotshape(i_vSpikeLb and is_vol_exhaustion, "üö¶ Vol Ki·ªát s·ª©c", shape.circle, location.abovebar, color.new(color.red, 0), text="üö¶", size=size.small, force_overlay=true)

// ‚ö° BI·∫æN ƒê·ªòNG L·ªéNG L·∫∫O (High ATR) - Ch·ªâ khi b·∫≠t v√† Spread > ng∆∞·ª°ng ATR
plotshape(i_hATRLb and is_high_volatility, "‚ö° Bi·∫øn ƒë·ªông", shape.diamond, location.abovebar, color.new(color.yellow, 0), text="‚ö°", size=size.small, force_overlay=true)

// VSA Icons
plotshape(is_shakeout or is_spring, "Spring/Shakeout", shape.diamond, location.belowbar, color.aqua, size=size.small, force_overlay=true)
plotshape(accumulation_sign, "Accumulation", shape.triangleup, location.belowbar, color.lime, text="üí∞", size=size.tiny, force_overlay=true)
plotshape(hidden_distribution, "Hidden Dist", shape.triangledown, location.abovebar, color.orange, text="‚ö†Ô∏è", size=size.tiny, force_overlay=true)
plotshape(is_upthrust, "Upthrust", shape.xcross, location.abovebar, color.red, size=size.small, force_overlay=true)

// RSI Divergence Icons
plotshape(hidden_bullish[pivot_lookback], "Hidden Bullish Div", shape.labelup, location.belowbar, color.blue, text="HD", size=size.small, force_overlay=true)
plotshape(regular_bullish[pivot_lookback], "Regular Bullish Div", shape.labelup, location.belowbar, color.purple, text="RD", size=size.small, force_overlay=true)
plotshape(regular_bearish[pivot_lookback], "Bearish Div", shape.labeldown, location.abovebar, color.red, text="BD", size=size.small, force_overlay=true)

// ==========================================
// 8. T√çN HI·ªÜU MUA/B√ÅN
// ==========================================

is_slope_up = mf > mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]
ck_cross_up = ta.crossover(ck_raw, 0)
ck_cross_down = ta.crossunder(ck_raw, 0)

var int bars_since_sell = 100
var int bars_since_buy = 100
bars_since_sell := bars_since_sell + 1
bars_since_buy := bars_since_buy + 1

cond_cmf_ok = mf > 0 and is_slope_up
cond_ema_ok = ema_count_above >= 2
cond_vsa_ok = accumulation_sign or is_spring or is_shakeout or easy_move_up
cond_cooldown_buy = bars_since_buy >= buy_cooldown

// MUA AN TO√ÄN
buy_safe = cond_cmf_ok and cond_ema_ok and ck_cross_up and cond_cooldown_buy

// MUA M·∫†NH (Wyckoff + RSI Confirm)
super_buy = (buy_safe and cond_vsa_ok) or hidden_bullish[pivot_lookback]

if buy_safe or super_buy
    bars_since_buy := 0

// MUA S·ªöM (RSI Divergence / Spring)
buy_early = ((is_spring or is_shakeout or accumulation_sign) and cmf_recovering and cond_cooldown_buy) or regular_bullish[pivot_lookback]

if buy_early
    bars_since_buy := 0

// B√ÅN
cond_cmf_weak = mf < 0 and mf < mf[1]
cond_ema_weak = ema_count_above <= 1
cond_vsa_sell = hidden_distribution or is_upthrust
cond_cooldown_sell = bars_since_sell >= sell_cooldown

sell_sig = ((cond_cmf_weak and ck_cross_down) or cond_vsa_sell or regular_bearish[pivot_lookback]) and cond_ema_weak and cond_cooldown_sell

if sell_sig
    bars_since_sell := 0

// C·∫£nh b√°o b√°n (RSI overbought + bearish div)
sell_warning = rsi_overbought and regular_bearish[pivot_lookback]

// ==========================================
// 9. HI·ªÇN TH·ªä T√çN HI·ªÜU
// ==========================================
plotshape(super_buy and not super_buy[1], "Super Buy", shape.labelup, location.bottom, color.yellow, text="üíé", size=size.normal)
plotshape(buy_safe and not super_buy and not buy_safe[1], "Buy Safe", shape.labelup, location.bottom, color.lime, text="M√öC", size=size.small)
plotshape(buy_early and not buy_safe and not buy_early[1], "Buy Early", shape.triangleup, location.bottom, color.orange, text="S·ªöM", size=size.small)
plotshape(sell_sig and not sell_sig[1], "Sell", shape.labeldown, location.top, color.red, text="B√ÅN", size=size.small)
plotshape(sell_warning and not sell_sig and not sell_warning[1], "Sell Warning", shape.xcross, location.top, color.fuchsia, size=size.tiny)

// ==========================================
// 10. DASHBOARD
// ==========================================
var table panel = table.new(position.top_right, 2, 8, border_width=1, force_overlay=true)
if barstate.islast
    table.cell(panel, 0, 0, "üêã TRINITY VSA", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // D√≤ng ti·ªÅn
    table.cell(panel, 0, 1, "D√≤ng ti·ªÅn:", bgcolor=color.white, text_halign=text.align_left)
    cmf_text = mf > 0.1 ? "V√ÄO M·∫†NH üî•" : mf > 0 ? "V√ÄO NH·∫∏ ‚úÖ" : mf > -0.1 ? "RA NH·∫∏ ‚ö†Ô∏è" : "RA M·∫†NH ‚ùå"
    table.cell(panel, 1, 1, cmf_text, bgcolor=mf > 0 ? color.lime : color.red, text_color=color.white)
    
    // Volume
    table.cell(panel, 0, 2, "Volume:", bgcolor=color.white, text_halign=text.align_left)
    vol_text = is_vol_climax ? "CLIMAX ‚ö°" : is_vol_high ? "CAO üìà" : is_vol_dry ? "C·∫†N üí§" : "BT"
    vol_color = is_vol_climax ? color.yellow : is_vol_high ? color.green : is_vol_dry ? color.gray : color.blue
    table.cell(panel, 1, 2, vol_text, text_color=vol_color)
    
    // RSI
    table.cell(panel, 0, 3, "RSI:", bgcolor=color.white, text_halign=text.align_left)
    rsi_text = rsi_overbought ? "QU√Å MUA ‚ö†Ô∏è" : rsi_oversold ? "QU√Å B√ÅN üí°" : str.tostring(rsi_val, "#")
    rsi_color = rsi_overbought ? color.red : rsi_oversold ? color.green : color.blue
    table.cell(panel, 1, 3, rsi_text, text_color=rsi_color)
    
    // RSI Divergence
    table.cell(panel, 0, 4, "Ph√¢n k·ª≥:", bgcolor=color.white, text_halign=text.align_left)
    div_text = hidden_bullish ? "·∫®N TƒÇNG üîµ" : regular_bullish ? "TH∆Ø·ªúNG üü£" : regular_bearish ? "GI·∫¢M üî¥" : "---"
    div_color = hidden_bullish or regular_bullish ? color.green : regular_bearish ? color.red : color.gray
    table.cell(panel, 1, 4, div_text, text_color=div_color)
    
    // Wyckoff
    table.cell(panel, 0, 5, "Wyckoff:", bgcolor=color.white, text_halign=text.align_left)
    wyckoff_text = is_spring ? "SPRING ‚ö°" : is_shakeout ? "SHAKE ‚ö°" : accumulation_sign ? "T√çCH üí∞" : hidden_distribution ? "PH√ÇN ‚ö†Ô∏è" : "---"
    wyckoff_color = is_spring or is_shakeout or accumulation_sign ? color.green : hidden_distribution ? color.red : color.gray
    table.cell(panel, 1, 5, wyckoff_text, text_color=wyckoff_color)
    
    // L∆∞·ªõt s√≥ng
    table.cell(panel, 0, 6, "L∆∞·ªõt s√≥ng:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 6, above_ema50 ? "OK ‚úÖ" : "D∆Ø·ªöI ‚ùå", text_color=above_ema50 ? color.green : color.red)
    
    // Trung h·∫°n
    table.cell(panel, 0, 7, "Trung h·∫°n:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 7, above_ema233 ? "UP ‚úÖ" : "DOWN ‚ùå", text_color=above_ema233 ? color.green : color.red)

// ==========================================
// ALERTS
// ==========================================
alertcondition(super_buy, "üíé MUA M·∫†NH", "Super Buy - Wyckoff + RSI Confirm!")
alertcondition(hidden_bullish, "üîµ HIDDEN BULLISH", "RSI Hidden Bullish Divergence - MUA L∆Ø·ªöT!")
alertcondition(regular_bullish, "üü£ REGULAR BULLISH", "RSI Regular Bullish Divergence - B·∫ÆT ƒê√ÅY!")
alertcondition(regular_bearish, "üî¥ BEARISH DIV", "RSI Bearish Divergence - C·∫¢NH B√ÅO!")
alertcondition(is_volatility_surge, "‚ö° VOLATILITY", "Volume/Price Surge Detected!")
alertcondition(sell_sig, "üî¥ B√ÅN", "Sell Signal!")
