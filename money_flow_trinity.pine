//@version=5
// Coder Stock - Money Flow Trinity Master (Wyckoff VSA Edition)
// T√≠ch h·ª£p: CMF + Chaikin + EOM + Wyckoff VSA Analysis
// Features: Candle Coloring, Volume Climax, Shakeout Detection, Effort vs Result
// Author: Vinh
indicator(title="CS Trinity Master VSA", shorttitle="CS_Trinity_VSA", format=format.price, precision=2)

// ==========================================
// 1. C·∫§U H√åNH
// ==========================================
grp_cmf = "1. CMF (D√≤ng Ti·ªÅn)"
cmf_len = input.int(20, "CMF Length", group=grp_cmf)

grp_ck = "2. Chaikin Oscillator"
ck_fast = input.int(3, "Fast", group=grp_ck)
ck_slow = input.int(10, "Slow", group=grp_ck)

grp_eom = "3. EOM"
eom_len = input.int(14, "Length", group=grp_eom)
eom_div = input.int(10000, "Divisor", group=grp_eom)

grp_vsa = "4. Wyckoff VSA"
vol_climax_mult = input.float(2.0, "Volume Climax (x TB)", group=grp_vsa, tooltip="Volume > X l·∫ßn trung b√¨nh = Climax")
vol_dry_mult = input.float(0.5, "Volume C·∫°n (x TB)", group=grp_vsa, tooltip="Volume < X l·∫ßn trung b√¨nh = C·∫°n")
spread_narrow = input.float(0.5, "Spread H·∫πp (x ATR)", group=grp_vsa)

grp_cooldown = "5. Ch·ªëng Nhi·ªÖu"
sell_cooldown = input.int(3, "Cooldown B√ÅN", minval=1, group=grp_cooldown)
buy_cooldown = input.int(3, "Cooldown MUA", minval=1, group=grp_cooldown)

// ==========================================
// 2. T√çNH TO√ÅN CORE
// ==========================================

// --- CMF ---
ad_val = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
mf = math.sum(ad_val, cmf_len) / math.sum(volume, cmf_len)

// --- Chaikin ---
ad_line = ta.accdist
ck_raw = ta.ema(ad_line, ck_fast) - ta.ema(ad_line, ck_slow)

// --- EOM ---
dm = ((high + low) / 2) - ((high[1] + low[1]) / 2)
br = (volume / eom_div) / ((high - low) != 0 ? (high - low) : 1)
eom_inst = br != 0 ? dm / br : 0
eom_raw = ta.sma(eom_inst, eom_len)

// --- EMAs ---
ema50 = ta.ema(close, 50)
ema144 = ta.ema(close, 144)
ema233 = ta.ema(close, 233)

above_ema50 = close > ema50
above_ema144 = close > ema144
above_ema233 = close > ema233
ema_count_above = (above_ema50 ? 1 : 0) + (above_ema144 ? 1 : 0) + (above_ema233 ? 1 : 0)
resistance_count = 3 - ema_count_above

// ==========================================
// 3. WYCKOFF VSA ANALYSIS
// ==========================================

// --- Volume Analysis ---
vol_sma = ta.sma(volume, 20)
vol_ratio = volume / vol_sma

// Volume States
is_vol_climax = vol_ratio >= vol_climax_mult     // üö¶ Volume Ki·ªát s·ª©c/Climax
is_vol_high = vol_ratio >= 1.5 and vol_ratio < vol_climax_mult  // High Vol
is_vol_normal = vol_ratio >= 0.8 and vol_ratio < 1.5
is_vol_dry = vol_ratio < vol_dry_mult            // C·∫°n Volume

// --- Spread Analysis (ƒê·ªô r·ªông n·∫øn) ---
atr_val = ta.atr(14)
spread = high - low
is_spread_wide = spread > atr_val * 1.5
is_spread_narrow = spread < atr_val * spread_narrow
is_spread_normal = not is_spread_wide and not is_spread_narrow

// --- Candle Character ---
is_bullish = close > open
is_bearish = close < open
close_position = (close - low) / (high - low)  // 0 = close ·ªü ƒë√°y, 1 = close ·ªü ƒë·ªânh

// --- EFFORT vs RESULT (N·ªó l·ª±c vs K·∫øt qu·∫£) ---
// High Effort = Volume cao
// Result = Spread (ƒë·ªô r·ªông n·∫øn)

// N·ªó l·ª±c l·ªõn, k·∫øt qu·∫£ nh·ªè -> C·∫£nh b√°o (c√≥ th·ªÉ ph√¢n ph·ªëi ·∫©n ho·∫∑c t√≠ch l≈©y)
effort_no_result_up = is_vol_climax and is_bullish and is_spread_narrow  // Vol cao, n·∫øn xanh nh∆∞ng spread h·∫πp
effort_no_result_down = is_vol_climax and is_bearish and is_spread_narrow  // Vol cao, n·∫øn ƒë·ªè nh∆∞ng spread h·∫πp

// N·ªó l·ª±c nh·ªè, k·∫øt qu·∫£ l·ªõn -> D·∫•u hi·ªáu t·ªët (d·ªÖ ƒëi)
easy_move_up = is_vol_dry and is_bullish and is_spread_wide  // Vol th·∫•p m√† gi√° tƒÉng m·∫°nh = C·∫°n cung
easy_move_down = is_vol_dry and is_bearish and is_spread_wide  // Vol th·∫•p m√† gi√° gi·∫£m m·∫°nh = C·∫°n c·∫ßu

// --- STOPPING ACTION (H√†nh ƒë·ªông d·ª´ng) ---
// N·∫øn xanh v·ªõi spread r·ªông, volume cao, ƒë√≥ng c·ª≠a g·∫ßn ƒë·ªânh -> Demand coming in
stopping_volume_down = is_bearish and is_vol_climax and close_position > 0.6  // N·∫øn ƒë·ªè nh∆∞ng ƒë√≥ng g·∫ßn ƒë·ªânh = Buying pressure

// --- SHAKEOUT (R≈© b·ªè) ---
// Gi√° ph√° ƒë√°y c≈© nh∆∞ng volume th·∫•p v√† ƒë√≥ng c·ª≠a g·∫ßn ƒë·ªânh n·∫øn
lowest_10 = ta.lowest(low, 10)
is_shakeout = low < lowest_10[1] and is_vol_dry and close_position > 0.5 and is_bullish

// --- SPRING (B·∫≠t l√≤ xo) ---
// Gi√° ch·ªçc xu·ªëng h·ªó tr·ª£ (EMA233) r·ªìi ƒë√≥ng tr√™n -> Bullish
is_spring = low < ema233 and close > ema233 and close > open

// --- UPTHRUST (ƒê·∫©y l√™n gi·∫£) ---
// Gi√° ch·ªçc l√™n kh√°ng c·ª± r·ªìi ƒë√≥ng d∆∞·ªõi -> Bearish
highest_10 = ta.highest(high, 10)
is_upthrust = high > highest_10[1] and close < open and close_position < 0.5

// --- HIDDEN DISTRIBUTION (Ph√¢n ph·ªëi ·∫©n) ---
// Volume climax + Gi√° kh√¥ng tƒÉng ƒë∆∞·ª£c + ƒê√≥ng c·ª≠a g·∫ßn ƒë√°y
hidden_distribution = is_vol_climax and is_bullish and close_position < 0.4

// --- ACCUMULATION SIGN (D·∫•u hi·ªáu t√≠ch l≈©y) ---
// Volume climax + N·∫øn ƒë·ªè nh∆∞ng ƒë√≥ng c·ª≠a g·∫ßn ƒë·ªânh (c√≥ mua v√†o)
accumulation_sign = is_vol_climax and is_bearish and close_position > 0.6

// ==========================================
// 4. CANDLE COLORING BY VOLUME (T√¥ m√†u n·∫øn theo Volume)
// ==========================================
// V√†ng (Gold) = Ti·ªÅn m·∫°nh v√†o (Vol cao + Bullish + Close g·∫ßn ƒë·ªânh)
// Xanh ƒë·∫≠m (Teal) = Ti·ªÅn m·∫°nh (Vol > TB + Bullish)
// X√°m = Ti·ªÅn y·∫øu (Vol th·∫•p)
// Xanh ng·ªçc nh·∫°t = Volume c·∫°n (Dry)

candle_color = is_vol_climax and is_bullish and close_position > 0.6 ? color.yellow :
               is_vol_climax and is_bearish and close_position > 0.6 ? color.aqua :  // Absorption
               is_vol_high and is_bullish ? color.teal :
               is_vol_high and is_bearish ? color.maroon :
               is_vol_dry ? color.gray :
               is_bullish ? color.green : color.red

// Apply to candles
barcolor(candle_color)

// ==========================================
// 5. AUTO-SCALING
// ==========================================
var float scaler = 0.0
stdev_cmf = ta.stdev(mf, 50)
stdev_ck = ta.stdev(ck_raw, 50)
if stdev_cmf != 0 and stdev_ck != 0
    scaler := stdev_ck / stdev_cmf
ck_visual = ck_raw / (scaler != 0 ? scaler : 1)

// ==========================================
// 6. HI·ªÇN TH·ªä HISTOGRAM
// ==========================================
hline(0, "Zero", color.gray, hline.style_dotted)
plot(mf, "CMF", style=plot.style_columns, color=mf > 0 ? color.new(color.teal, 40) : color.new(color.red, 40), linewidth=3)
plot(ck_visual, "Chaikin", color=color.orange, linewidth=2)

// EMAs (Overlay)
plot(ema50, "EMA 50", color=above_ema50 ? color.lime : color.red, linewidth=2, force_overlay=true)
plot(ema144, "EMA 144", color=above_ema144 ? color.lime : color.red, linewidth=3, force_overlay=true)
plot(ema233, "EMA 233", color=above_ema233 ? color.lime : color.red, linewidth=4, force_overlay=true)

// ==========================================
// 7. VSA WARNING ICONS
// ==========================================
// üö¶ Volume Climax (c√≥ th·ªÉ l√† ƒë·ªânh/ƒë√°y)
plotshape(is_vol_climax, "Vol Climax", shape.circle, location.abovebar, color.new(color.yellow, 0), size=size.tiny, force_overlay=true)

// ‚ö° Shakeout / Spring
plotshape(is_shakeout or is_spring, "Shakeout/Spring", shape.diamond, location.belowbar, color.aqua, text="‚ö°", size=size.small, force_overlay=true)

// ‚ö†Ô∏è Hidden Distribution
plotshape(hidden_distribution, "Hidden Dist", shape.triangledown, location.abovebar, color.orange, text="‚ö†Ô∏è", size=size.tiny, force_overlay=true)

// ‚úÖ Accumulation Sign
plotshape(accumulation_sign, "Accumulation", shape.triangleup, location.belowbar, color.lime, text="üí∞", size=size.tiny, force_overlay=true)

// üîª Upthrust
plotshape(is_upthrust, "Upthrust", shape.xcross, location.abovebar, color.red, size=size.small, force_overlay=true)

// ==========================================
// 8. T√çN HI·ªÜU MUA/B√ÅN (VSA Enhanced)
// ==========================================

// Slope
is_slope_up = mf > mf[1]
is_slope_down = mf < mf[1]
cmf_recovering = mf < 0 and mf > mf[1] and mf[1] > mf[2]

// Crossovers
ck_cross_up = ta.crossover(ck_raw, 0)
ck_cross_down = ta.crossunder(ck_raw, 0)

// Cooldown
var int bars_since_sell = 100
var int bars_since_buy = 100
bars_since_sell := bars_since_sell + 1
bars_since_buy := bars_since_buy + 1

// === MUA AN TO√ÄN ===
// CMF d∆∞∆°ng + √çt nh·∫•t 2 EMA h·ªó tr·ª£ + C√≥ d·∫•u hi·ªáu t√≠ch l≈©y/spring
cond_cmf_ok = mf > 0 and is_slope_up
cond_ema_ok = ema_count_above >= 2
cond_vsa_ok = accumulation_sign or is_spring or is_shakeout or easy_move_up
cond_cooldown_buy = bars_since_buy >= buy_cooldown

buy_safe = cond_cmf_ok and cond_ema_ok and ck_cross_up and cond_cooldown_buy

// === MUA M·∫†NH (Wyckoff Confirm) ===
super_buy = buy_safe and cond_vsa_ok

if buy_safe or super_buy
    bars_since_buy := 0

// === MUA S·ªöM (Spring/Shakeout) ===
buy_early = (is_spring or is_shakeout or accumulation_sign) and cmf_recovering and cond_cooldown_buy

if buy_early
    bars_since_buy := 0

// === B√ÅN ===
cond_cmf_weak = mf < 0 and is_slope_down
cond_ema_weak = ema_count_above <= 1
cond_vsa_sell = hidden_distribution or is_upthrust or effort_no_result_up
cond_cooldown_sell = bars_since_sell >= sell_cooldown

sell_sig = ((cond_cmf_weak and ck_cross_down) or cond_vsa_sell) and cond_ema_weak and cond_cooldown_sell

if sell_sig
    bars_since_sell := 0

// ==========================================
// 9. HI·ªÇN TH·ªä T√çN HI·ªÜU
// ==========================================
plotshape(super_buy and not super_buy[1], "Super Buy", shape.labelup, location.bottom, color.yellow, text="üíé", size=size.normal)
plotshape(buy_safe and not super_buy and not buy_safe[1], "Buy Safe", shape.labelup, location.bottom, color.lime, text="M√öC", size=size.small)
plotshape(buy_early and not buy_safe and not buy_early[1], "Buy Early", shape.triangleup, location.bottom, color.orange, text="S·ªöM", size=size.small)
plotshape(sell_sig and not sell_sig[1], "Sell", shape.labeldown, location.top, color.red, text="B√ÅN", size=size.small)

// ==========================================
// 10. DASHBOARD
// ==========================================
var table panel = table.new(position.top_right, 2, 7, border_width=1, force_overlay=true)
if barstate.islast
    table.cell(panel, 0, 0, "üêã TRINITY VSA", bgcolor=color.black, text_color=color.white)
    table.cell(panel, 1, 0, "BY VINH", bgcolor=color.black, text_color=color.yellow)
    
    // D√≤ng ti·ªÅn
    table.cell(panel, 0, 1, "D√≤ng ti·ªÅn:", bgcolor=color.white, text_halign=text.align_left)
    cmf_text = mf > 0.1 ? "V√ÄO M·∫†NH üî•" : mf > 0 ? "V√ÄO NH·∫∏ ‚úÖ" : mf > -0.1 ? "RA NH·∫∏ ‚ö†Ô∏è" : "RA M·∫†NH ‚ùå"
    table.cell(panel, 1, 1, cmf_text, bgcolor=mf > 0 ? color.lime : color.red, text_color=color.white)
    
    // Volume State
    table.cell(panel, 0, 2, "Volume:", bgcolor=color.white, text_halign=text.align_left)
    vol_text = is_vol_climax ? "CLIMAX üö¶" : is_vol_high ? "CAO üìà" : is_vol_dry ? "C·∫†N üí§" : "B√åNH TH∆Ø·ªúNG"
    vol_color = is_vol_climax ? color.yellow : is_vol_high ? color.green : is_vol_dry ? color.gray : color.blue
    table.cell(panel, 1, 2, vol_text, text_color=vol_color)
    
    // Wyckoff Signal
    table.cell(panel, 0, 3, "Wyckoff:", bgcolor=color.white, text_halign=text.align_left)
    wyckoff_text = is_spring ? "SPRING ‚ö°" : is_shakeout ? "SHAKEOUT ‚ö°" : accumulation_sign ? "T√çCH L≈®Y üí∞" : hidden_distribution ? "PH√ÇN PH·ªêI ‚ö†Ô∏è" : is_upthrust ? "UPTHRUST ‚ùå" : "---"
    wyckoff_color = is_spring or is_shakeout or accumulation_sign ? color.green : hidden_distribution or is_upthrust ? color.red : color.gray
    table.cell(panel, 1, 3, wyckoff_text, text_color=wyckoff_color)
    
    // L∆∞·ªõt s√≥ng
    table.cell(panel, 0, 4, "L∆∞·ªõt s√≥ng:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 4, above_ema50 ? "OK ‚úÖ" : "D∆Ø·ªöI ‚ùå", text_color=above_ema50 ? color.green : color.red)
    
    // Trung h·∫°n
    table.cell(panel, 0, 5, "Trung h·∫°n:", bgcolor=color.white, text_halign=text.align_left)
    table.cell(panel, 1, 5, above_ema233 ? "UPTREND ‚úÖ" : "DOWNTREND ‚ùå", text_color=above_ema233 ? color.green : color.red)
    
    // C·∫£n
    table.cell(panel, 0, 6, "C·∫£n tr√™n:", bgcolor=color.white, text_halign=text.align_left)
    res_text = resistance_count == 0 ? "KH√îNG üöÄ" : str.tostring(resistance_count) + " C·∫¢N"
    table.cell(panel, 1, 6, res_text, text_color=resistance_count == 0 ? color.green : color.orange)

// ==========================================
// ALERTS
// ==========================================
alertcondition(super_buy, "üíé MUA M·∫†NH (Wyckoff)", "Wyckoff Confirm + All signals aligned!")
alertcondition(buy_safe, "‚úÖ MUA AN TO√ÄN", "Buy signal")
alertcondition(is_spring or is_shakeout, "‚ö° SPRING/SHAKEOUT", "Potential reversal point!")
alertcondition(hidden_distribution, "‚ö†Ô∏è PH√ÇN PH·ªêI ·∫®N", "Hidden distribution detected!")
alertcondition(sell_sig, "üî¥ B√ÅN", "Sell signal")
