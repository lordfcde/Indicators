//@version=6
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Fibonacci Pivot Points - Custom Levels
// Features: S3-S1 / PP / R1-R3 with Fibonacci ratios and prices
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
indicator("Fibonacci Pivot Points", "FIB PP", overlay=true, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_main = "âš™ï¸ Main Settings"
pivotAnchorInput = input.string(title="Pivots Timeframe", defval="Auto", options=["Auto", "Daily", "Weekly", "Monthly", "Quarterly", "Yearly"], group=group_main)
showLabelsInput = input.bool(title="Show Labels", defval=true, group=group_main)
showPricesInput = input.bool(title="Show Prices", defval=true, group=group_main)
positionLabelsInput = input.string("Right", "Labels Position", options=["Left", "Right"], group=group_main)
maxHistoricalPivots = input.int(title="Number of Pivots Back", defval=5, minval=1, maxval=50, group=group_main)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIBONACCI LEVELS - S3, S2, S1, PP, R1, R2, R3 with ratios
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_levels = "ğŸ“Š Fibonacci Pivot Levels"

// PP - Pivot Point (ratio = 0)
pp_show = input.bool(true, "PP", inline="pp", group=group_levels)
pp_ratio = input.float(0.0, "", inline="pp", group=group_levels)
pp_color = input.color(#E91E63, "", inline="pp", group=group_levels)

// R1/S1 - 0.382
r1s1_show = input.bool(true, "R1/S1 PP", inline="r1s1", group=group_levels)
r1s1_ratio = input.float(0.382, "", inline="r1s1", group=group_levels)
r1s1_color = input.color(#81C784, "", inline="r1s1", group=group_levels)

// R2/S2 - 0.618 (Golden Ratio - Important)
r2s2_show = input.bool(true, "R2/S2 PP â˜…", inline="r2s2", group=group_levels)
r2s2_ratio = input.float(0.618, "", inline="r2s2", group=group_levels)
r2s2_color = input.color(#009688, "", inline="r2s2", group=group_levels)

// R3/S3 - 1.0 (Important)
r3s3_show = input.bool(true, "R3/S3 PP â˜…", inline="r3s3", group=group_levels)
r3s3_ratio = input.float(1.0, "", inline="r3s3", group=group_levels)
r3s3_color = input.color(#2196F3, "", inline="r3s3", group=group_levels)

// Additional Fibonacci Levels
group_ext = "ğŸ“ˆ Extended Fibonacci Levels"

// PP 0.236
pp236_show = input.bool(true, "PP 0.236", inline="pp236", group=group_ext)
pp236_ratio = input.float(0.236, "", inline="pp236", group=group_ext)
pp236_color = input.color(#9C27B0, "", inline="pp236", group=group_ext)

// PP 0.5
pp5_show = input.bool(true, "PP 0.5", inline="pp5", group=group_ext)
pp5_ratio = input.float(0.5, "", inline="pp5", group=group_ext)
pp5_color = input.color(#4CAF50, "", inline="pp5", group=group_ext)

// PP 0.786
pp786_show = input.bool(true, "PP 0.786", inline="pp786", group=group_ext)
pp786_ratio = input.float(0.786, "", inline="pp786", group=group_ext)
pp786_color = input.color(#00BCD4, "", inline="pp786", group=group_ext)

// PP 1.272
pp1272_show = input.bool(true, "PP 1.272", inline="pp1272", group=group_ext)
pp1272_ratio = input.float(1.272, "", inline="pp1272", group=group_ext)
pp1272_color = input.color(#3F51B5, "", inline="pp1272", group=group_ext)

// PP 1.618 (Golden Extension - Important)
pp1618_show = input.bool(true, "PP 1.618 â˜…", inline="pp1618", group=group_ext)
pp1618_ratio = input.float(1.618, "", inline="pp1618", group=group_ext)
pp1618_color = input.color(#673AB7, "", inline="pp1618", group=group_ext)

// PP 2.618
pp2618_show = input.bool(false, "PP 2.618", inline="pp2618", group=group_ext)
pp2618_ratio = input.float(2.618, "", inline="pp2618", group=group_ext)
pp2618_color = input.color(#E91E63, "", inline="pp2618", group=group_ext)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO TIMEFRAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
autoAnchor = switch
    timeframe.isintraday => timeframe.multiplier <= 15 ? "1D" : "1W"
    timeframe.isdaily    => "1M"
    => "12M"

pivotTimeframe = switch pivotAnchorInput
    "Auto"      => autoAnchor
    "Daily"     => "1D"
    "Weekly"    => "1W"
    "Monthly"   => "1M"
    "Quarterly" => "3M"
    => "12M"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HTF OHLC DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
f_htf_ohlc(_htf) =>
    var float htf_h = na
    var float htf_l = na
    var float htf_c = na
    var float prev_h = na
    var float prev_l = na
    var float prev_c = na
    
    if timeframe.change(_htf)
        prev_h := htf_h
        prev_l := htf_l
        prev_c := htf_c
        htf_h := high
        htf_l := low
    else
        htf_h := math.max(nz(htf_h), high)
        htf_l := math.min(nz(htf_l, low), low)
    
    htf_c := close
    [prev_h, prev_l, prev_c]

[htf_h, htf_l, htf_c] = f_htf_ohlc(pivotTimeframe)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIVOT CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
pivot = (htf_h + htf_l + htf_c) / 3
range_hl = htf_h - htf_l

// Important ratios (solid lines): 0, 0.382, 0.618, 1.0, 1.618
isImportant(ratio) => ratio == 0.0 or ratio == 0.382 or ratio == 0.618 or ratio == 1.0 or ratio == 1.618

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING ARRAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var lines_arr = array.new_line()
var labels_arr = array.new_label()

// Clean old drawings
if barstate.islast
    while array.size(lines_arr) > 0
        line.delete(array.shift(lines_arr))
    while array.size(labels_arr) > 0
        label.delete(array.shift(labels_arr))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
drawPivotLevel(show, ratio, col, levelName) =>
    if show and not na(pivot) and not na(range_hl) and barstate.islast
        // Calculate Resistance price
        priceR = pivot + range_hl * ratio
        // Calculate Support price  
        priceS = pivot - range_hl * ratio
        
        lineStyle = isImportant(ratio) ? line.style_solid : line.style_dashed
        lineWidth = isImportant(ratio) ? 2 : 1
        
        // Time coordinates
        time_start = ta.valuewhen(timeframe.change(pivotTimeframe), time, 0)
        time_end = time_start + timeframe.in_seconds(pivotTimeframe) * 1000
        labelTime = positionLabelsInput == "Left" ? time_start : time_end
        labelStyle = positionLabelsInput == "Left" ? label.style_label_right : label.style_label_left
        
        if ratio == 0.0
            // PP center line
            ln = line.new(time_start, pivot, time_end, pivot, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            array.push(lines_arr, ln)
            
            labelText = showLabelsInput ? "PP" : ""
            priceText = showPricesInput ? " (" + str.tostring(pivot, format.mintick) + ")" : ""
            if labelText != "" or priceText != ""
                lb = label.new(labelTime, pivot, labelText + priceText, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
                array.push(labels_arr, lb)
        else
            // Resistance line
            lnR = line.new(time_start, priceR, time_end, priceR, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            array.push(lines_arr, lnR)
            
            // Support line
            lnS = line.new(time_start, priceS, time_end, priceS, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            array.push(lines_arr, lnS)
            
            // Label for Resistance: "R3 PP 1.0 (31950)"
            rLabel = showLabelsInput ? levelName + " " + str.tostring(ratio) : str.tostring(ratio)
            rPrice = showPricesInput ? " (" + str.tostring(priceR, format.mintick) + ")" : ""
            lbR = label.new(labelTime, priceR, rLabel + rPrice, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
            array.push(labels_arr, lbR)
            
            // Label for Support: "S3 PP 1.0 (22200)"
            sLabel = showLabelsInput ? str.replace(levelName, "R", "S") + " " + str.tostring(ratio) : str.tostring(ratio)
            sPrice = showPricesInput ? " (" + str.tostring(priceS, format.mintick) + ")" : ""
            lbS = label.new(labelTime, priceS, sLabel + sPrice, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
            array.push(labels_arr, lbS)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW ALL LEVELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Standard Pivot Points
drawPivotLevel(pp_show, pp_ratio, pp_color, "PP")
drawPivotLevel(r1s1_show, r1s1_ratio, r1s1_color, "R1 PP")
drawPivotLevel(r2s2_show, r2s2_ratio, r2s2_color, "R2 PP")
drawPivotLevel(r3s3_show, r3s3_ratio, r3s3_color, "R3 PP")

// Extended Fibonacci Levels
drawPivotLevel(pp236_show, pp236_ratio, pp236_color, "R PP")
drawPivotLevel(pp5_show, pp5_ratio, pp5_color, "R PP")
drawPivotLevel(pp786_show, pp786_ratio, pp786_color, "R PP")
drawPivotLevel(pp1272_show, pp1272_ratio, pp1272_color, "R PP")
drawPivotLevel(pp1618_show, pp1618_ratio, pp1618_color, "R PP")
drawPivotLevel(pp2618_show, pp2618_ratio, pp2618_color, "R PP")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(ta.cross(close, pivot), "Cross Pivot Point", "Price crossed Pivot Point")
