//@version=6
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Fibonacci Pivot Points - Custom Levels
// Author: Â© Vinh
// Features: 10+ customizable Fibonacci levels with prices, auto timeframe
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
indicator("Fibonacci Pivot Points", "FIB PP", overlay=true, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_main = "âš™ï¸ Main Settings"
pivotAnchorInput = input.string(title="Pivots Timeframe", defval="Auto", options=["Auto", "Daily", "Weekly", "Monthly", "Quarterly", "Yearly"], group=group_main)
showLabelsInput = input.bool(title="Show Labels", defval=true, group=group_main)
showPricesInput = input.bool(title="Show Prices", defval=true, group=group_main)
positionLabelsInput = input.string("Right", "Labels Position", options=["Left", "Right"], group=group_main)
maxHistoricalPivots = input.int(title="Number of Pivots Back", defval=5, minval=1, maxval=50, group=group_main)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIBONACCI LEVELS - Customizable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_levels = "ğŸ“Š Fibonacci Levels"

// PP - Pivot Point (ratio = 0)
pp_show = input.bool(true, "PP", inline="pp", group=group_levels)
pp_ratio = input.float(0.0, "", inline="pp", group=group_levels)
pp_color = input.color(#E91E63, "", inline="pp", group=group_levels)

// Level 1 - 0.236
l1_show = input.bool(true, "Level 1", inline="l1", group=group_levels)
l1_ratio = input.float(0.236, "", inline="l1", group=group_levels)
l1_color = input.color(#9C27B0, "", inline="l1", group=group_levels)

// Level 2 - 0.382 (Important)
l2_show = input.bool(true, "Level 2 â˜…", inline="l2", group=group_levels)
l2_ratio = input.float(0.382, "", inline="l2", group=group_levels)
l2_color = input.color(#81C784, "", inline="l2", group=group_levels)

// Level 3 - 0.5
l3_show = input.bool(true, "Level 3", inline="l3", group=group_levels)
l3_ratio = input.float(0.5, "", inline="l3", group=group_levels)
l3_color = input.color(#4CAF50, "", inline="l3", group=group_levels)

// Level 4 - 0.618 (Important - Golden Ratio)
l4_show = input.bool(true, "Level 4 â˜…", inline="l4", group=group_levels)
l4_ratio = input.float(0.618, "", inline="l4", group=group_levels)
l4_color = input.color(#009688, "", inline="l4", group=group_levels)

// Level 5 - 0.786
l5_show = input.bool(true, "Level 5", inline="l5", group=group_levels)
l5_ratio = input.float(0.786, "", inline="l5", group=group_levels)
l5_color = input.color(#00BCD4, "", inline="l5", group=group_levels)

// Level 6 - 1.0 (Important)
l6_show = input.bool(true, "Level 6 â˜…", inline="l6", group=group_levels)
l6_ratio = input.float(1.0, "", inline="l6", group=group_levels)
l6_color = input.color(#2196F3, "", inline="l6", group=group_levels)

// Level 7 - 1.272
l7_show = input.bool(true, "Level 7", inline="l7", group=group_levels)
l7_ratio = input.float(1.272, "", inline="l7", group=group_levels)
l7_color = input.color(#3F51B5, "", inline="l7", group=group_levels)

// Level 8 - 1.618 (Important - Golden Extension)
l8_show = input.bool(true, "Level 8 â˜…", inline="l8", group=group_levels)
l8_ratio = input.float(1.618, "", inline="l8", group=group_levels)
l8_color = input.color(#673AB7, "", inline="l8", group=group_levels)

// Level 9 - 2.0
l9_show = input.bool(false, "Level 9", inline="l9", group=group_levels)
l9_ratio = input.float(2.0, "", inline="l9", group=group_levels)
l9_color = input.color(#9C27B0, "", inline="l9", group=group_levels)

// Level 10 - 2.618
l10_show = input.bool(false, "Level 10", inline="l10", group=group_levels)
l10_ratio = input.float(2.618, "", inline="l10", group=group_levels)
l10_color = input.color(#E91E63, "", inline="l10", group=group_levels)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO TIMEFRAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
autoAnchor = switch
    timeframe.isintraday => timeframe.multiplier <= 15 ? "1D" : "1W"
    timeframe.isdaily    => "1M"
    => "12M"

pivotTimeframe = switch pivotAnchorInput
    "Auto"      => autoAnchor
    "Daily"     => "1D"
    "Weekly"    => "1W"
    "Monthly"   => "1M"
    "Quarterly" => "3M"
    => "12M"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HTF OHLC DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
f_htf_ohlc(_htf) =>
    var float htf_h = na
    var float htf_l = na
    var float htf_c = na
    var float prev_h = na
    var float prev_l = na
    var float prev_c = na
    
    if timeframe.change(_htf)
        prev_h := htf_h
        prev_l := htf_l
        prev_c := htf_c
        htf_h := high
        htf_l := low
    else
        htf_h := math.max(nz(htf_h), high)
        htf_l := math.min(nz(htf_l, low), low)
    
    htf_c := close
    [prev_h, prev_l, prev_c]

[htf_h, htf_l, htf_c] = f_htf_ohlc(pivotTimeframe)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIVOT CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
pivot = (htf_h + htf_l + htf_c) / 3
range_hl = htf_h - htf_l

// Important ratios (solid lines): 0, 0.382, 0.618, 1.0, 1.618
isImportant(ratio) => ratio == 0.0 or ratio == 0.382 or ratio == 0.618 or ratio == 1.0 or ratio == 1.618

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var lines_r = array.new_line()
var lines_s = array.new_line()
var labels_r = array.new_label()
var labels_s = array.new_label()

// Clean old drawings on new period
if timeframe.change(pivotTimeframe)
    // Keep only maxHistoricalPivots
    while array.size(lines_r) > maxHistoricalPivots * 10
        line.delete(array.shift(lines_r))
        line.delete(array.shift(lines_s))
    while array.size(labels_r) > maxHistoricalPivots * 10
        label.delete(array.shift(labels_r))
        label.delete(array.shift(labels_s))

// Draw function
drawLevel(show, ratio, col, isResistance) =>
    if show and not na(pivot) and not na(range_hl)
        price = isResistance ? pivot + range_hl * ratio : pivot - range_hl * ratio
        if ratio == 0.0
            price := pivot
        
        lineStyle = isImportant(ratio) ? line.style_solid : line.style_dashed
        lineWidth = isImportant(ratio) ? 2 : 1
        
        // Label text
        levelName = ratio == 0.0 ? "PP" : (isResistance ? "R " : "S ") + str.tostring(ratio)
        priceText = showPricesInput ? " (" + str.tostring(price, format.mintick) + ")" : ""
        labelText = showLabelsInput ? levelName + priceText : (showPricesInput ? str.tostring(price, format.mintick) : "")
        
        // Time coordinates
        time_start = ta.valuewhen(timeframe.change(pivotTimeframe), time, 0)
        time_end = time_start + timeframe.in_seconds(pivotTimeframe) * 1000
        
        if barstate.islast
            // Draw line
            ln = line.new(time_start, price, time_end, price, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            if isResistance
                array.push(lines_r, ln)
            else
                array.push(lines_s, ln)
            
            // Draw label
            if labelText != ""
                labelTime = positionLabelsInput == "Left" ? time_start : time_end
                labelStyle = positionLabelsInput == "Left" ? label.style_label_right : label.style_label_left
                lb = label.new(labelTime, price, labelText, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
                if isResistance
                    array.push(labels_r, lb)
                else
                    array.push(labels_s, lb)

// Draw PP (center)
drawLevel(pp_show, pp_ratio, pp_color, true)

// Draw Resistance levels
drawLevel(l1_show, l1_ratio, l1_color, true)
drawLevel(l2_show, l2_ratio, l2_color, true)
drawLevel(l3_show, l3_ratio, l3_color, true)
drawLevel(l4_show, l4_ratio, l4_color, true)
drawLevel(l5_show, l5_ratio, l5_color, true)
drawLevel(l6_show, l6_ratio, l6_color, true)
drawLevel(l7_show, l7_ratio, l7_color, true)
drawLevel(l8_show, l8_ratio, l8_color, true)
drawLevel(l9_show, l9_ratio, l9_color, true)
drawLevel(l10_show, l10_ratio, l10_color, true)

// Draw Support levels
drawLevel(l1_show, l1_ratio, l1_color, false)
drawLevel(l2_show, l2_ratio, l2_color, false)
drawLevel(l3_show, l3_ratio, l3_color, false)
drawLevel(l4_show, l4_ratio, l4_color, false)
drawLevel(l5_show, l5_ratio, l5_color, false)
drawLevel(l6_show, l6_ratio, l6_color, false)
drawLevel(l7_show, l7_ratio, l7_color, false)
drawLevel(l8_show, l8_ratio, l8_color, false)
drawLevel(l9_show, l9_ratio, l9_color, false)
drawLevel(l10_show, l10_ratio, l10_color, false)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(ta.cross(close, pivot), "Cross Pivot Point", "Price crossed Pisvot Point")
