//@version=6
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Fibonacci Pivot Points - Custom Levels (13 Levels)
// Features: S6-S1 / PP / R1-R6 with Fibonacci ratios, prices, line styles
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
indicator("Fibonacci Pivot Points", "FIB PP", overlay=true, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_main = "âš™ï¸ Main Settings"

tooltip_htf = 'Auto Mode (Default):\n' +
 'Automatically selects an appropriate higher timeframe based on the chart timeframe:\n' +
 'â€¢ Intraday â‰¤ 15 min â†’ Daily pivots\n' +
 'â€¢ Intraday 30-240 min â†’ Weekly pivots\n' +
 'â€¢ Daily charts â†’ Monthly pivots\n' +
 'â€¢ Weekly / Monthly charts â†’ Yearly pivots\n\n' +
 'Auto mode is designed to provide context-aware pivot levels without manual adjustment.'

pivotAnchorInput = input.string(title="Pivots Timeframe", defval="Auto", options=["Auto", "Daily", "Weekly", "Monthly", "Quarterly", "Yearly"], group=group_main, tooltip=tooltip_htf)
showLabelsInput = input.bool(title="Show Labels", defval=true, group=group_main)
showPricesInput = input.bool(title="Show Prices", defval=true, group=group_main)
positionLabelsInput = input.string("Right", "Labels Position", options=["Left", "Right"], group=group_main)
maxHistoricalPivots = input.int(title="Number of Pivots Back", defval=5, minval=1, maxval=50, group=group_main)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIBONACCI LEVELS - 13 Levels with ratios + LINE STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
group_levels = "ğŸ“Š Fibonacci Levels"

// PP - Pivot Point (ratio = 0)
pp_show = input.bool(true, "PP", inline="pp", group=group_levels)
pp_ratio = input.float(0.0, "", inline="pp", group=group_levels)
pp_color = input.color(#787B86, "", inline="pp", group=group_levels)
pp_style = input.string("Solid", "", options=["Solid", "Dashed", "Dotted"], inline="pp", group=group_levels)

// Level 1 - 0.382 (R1/S1)
l1_show = input.bool(true, "Level 1", inline="l1", group=group_levels)
l1_ratio = input.float(0.382, "", inline="l1", group=group_levels)
l1_color = input.color(#9C27B0, "", inline="l1", group=group_levels)
l1_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l1", group=group_levels)

// Level 2 â˜… - 0.618 (Important - Golden)
l2_show = input.bool(true, "Level 2 â˜…", inline="l2", group=group_levels)
l2_ratio = input.float(0.618, "", inline="l2", group=group_levels)
l2_color = input.color(#81C784, "", inline="l2", group=group_levels)
l2_style = input.string("Solid", "", options=["Solid", "Dashed", "Dotted"], inline="l2", group=group_levels)

// Level 3 - 0.5
l3_show = input.bool(true, "Level 3", inline="l3", group=group_levels)
l3_ratio = input.float(0.5, "", inline="l3", group=group_levels)
l3_color = input.color(#4CAF50, "", inline="l3", group=group_levels)
l3_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l3", group=group_levels)

// Level 4 â˜… - 0.786
l4_show = input.bool(true, "Level 4 â˜…", inline="l4", group=group_levels)
l4_ratio = input.float(0.786, "", inline="l4", group=group_levels)
l4_color = input.color(#009688, "", inline="l4", group=group_levels)
l4_style = input.string("Solid", "", options=["Solid", "Dashed", "Dotted"], inline="l4", group=group_levels)

// Level 5 - 0.886
l5_show = input.bool(true, "Level 5", inline="l5", group=group_levels)
l5_ratio = input.float(0.886, "", inline="l5", group=group_levels)
l5_color = input.color(#00BCD4, "", inline="l5", group=group_levels)
l5_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l5", group=group_levels)

// Level 6 â˜… - 1.0 (Important)
l6_show = input.bool(true, "Level 6 â˜…", inline="l6", group=group_levels)
l6_ratio = input.float(1.0, "", inline="l6", group=group_levels)
l6_color = input.color(#2196F3, "", inline="l6", group=group_levels)
l6_style = input.string("Solid", "", options=["Solid", "Dashed", "Dotted"], inline="l6", group=group_levels)

// Level 7 - 1.272
l7_show = input.bool(true, "Level 7", inline="l7", group=group_levels)
l7_ratio = input.float(1.272, "", inline="l7", group=group_levels)
l7_color = input.color(#3F51B5, "", inline="l7", group=group_levels)
l7_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l7", group=group_levels)

// Level 8 â˜… - 1.618 (Important - Golden Extension)
l8_show = input.bool(true, "Level 8 â˜…", inline="l8", group=group_levels)
l8_ratio = input.float(1.618, "", inline="l8", group=group_levels)
l8_color = input.color(#673AB7, "", inline="l8", group=group_levels)
l8_style = input.string("Solid", "", options=["Solid", "Dashed", "Dotted"], inline="l8", group=group_levels)

// Level 9 - 2.0
l9_show = input.bool(true, "Level 9", inline="l9", group=group_levels)
l9_ratio = input.float(2.0, "", inline="l9", group=group_levels)
l9_color = input.color(#9C27B0, "", inline="l9", group=group_levels)
l9_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l9", group=group_levels)

// Level 10 - 2.618
l10_show = input.bool(true, "Level 10", inline="l10", group=group_levels)
l10_ratio = input.float(2.618, "", inline="l10", group=group_levels)
l10_color = input.color(#E91E63, "", inline="l10", group=group_levels)
l10_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l10", group=group_levels)

// Level 11 - 3.618
l11_show = input.bool(false, "Level 11", inline="l11", group=group_levels)
l11_ratio = input.float(3.618, "", inline="l11", group=group_levels)
l11_color = input.color(#F44336, "", inline="l11", group=group_levels)
l11_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l11", group=group_levels)

// Level 12 - 4.236
l12_show = input.bool(false, "Level 12", inline="l12", group=group_levels)
l12_ratio = input.float(4.236, "", inline="l12", group=group_levels)
l12_color = input.color(#FF5722, "", inline="l12", group=group_levels)
l12_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l12", group=group_levels)

// Level 13 - 4.618
l13_show = input.bool(false, "Level 13", inline="l13", group=group_levels)
l13_ratio = input.float(4.618, "", inline="l13", group=group_levels)
l13_color = input.color(#FF9800, "", inline="l13", group=group_levels)
l13_style = input.string("Dashed", "", options=["Solid", "Dashed", "Dotted"], inline="l13", group=group_levels)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO TIMEFRAME - Context-aware
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
autoAnchor = switch
    timeframe.isintraday and timeframe.multiplier <= 15 => "1D"      // Intraday â‰¤ 15 min â†’ Daily
    timeframe.isintraday and timeframe.multiplier <= 240 => "1W"     // Intraday 30-240 min â†’ Weekly
    timeframe.isdaily => "1M"                                         // Daily â†’ Monthly
    timeframe.isweekly or timeframe.ismonthly => "12M"               // Weekly/Monthly â†’ Yearly
    => "1M"

pivotTimeframe = switch pivotAnchorInput
    "Auto"      => autoAnchor
    "Daily"     => "1D"
    "Weekly"    => "1W"
    "Monthly"   => "1M"
    "Quarterly" => "3M"
    => "12M"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HTF OHLC DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
f_htf_ohlc(_htf) =>
    var float htf_h = na
    var float htf_l = na
    var float htf_c = na
    var float prev_h = na
    var float prev_l = na
    var float prev_c = na
    
    if timeframe.change(_htf)
        prev_h := htf_h
        prev_l := htf_l
        prev_c := htf_c
        htf_h := high
        htf_l := low
    else
        htf_h := math.max(nz(htf_h), high)
        htf_l := math.min(nz(htf_l, low), low)
    
    htf_c := close
    [prev_h, prev_l, prev_c]

[htf_h, htf_l, htf_c] = f_htf_ohlc(pivotTimeframe)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIVOT CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
pivot = (htf_h + htf_l + htf_c) / 3
range_hl = htf_h - htf_l

// Convert style string to line style
getLineStyle(styleStr) =>
    styleStr == "Solid" ? line.style_solid : styleStr == "Dashed" ? line.style_dashed : line.style_dotted

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING ARRAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var lines_arr = array.new_line()
var labels_arr = array.new_label()

// Clean old drawings
if barstate.islast
    while array.size(lines_arr) > 0
        line.delete(array.shift(lines_arr))
    while array.size(labels_arr) > 0
        label.delete(array.shift(labels_arr))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
drawPivotLevel(show, ratio, col, styleStr, levelNum) =>
    if show and not na(pivot) and not na(range_hl) and barstate.islast
        priceR = pivot + range_hl * ratio
        priceS = pivot - range_hl * ratio
        
        lineStyle = getLineStyle(styleStr)
        lineWidth = styleStr == "Solid" ? 2 : 1
        
        time_start = ta.valuewhen(timeframe.change(pivotTimeframe), time, 0)
        time_end = time_start + timeframe.in_seconds(pivotTimeframe) * 1000
        labelTime = positionLabelsInput == "Left" ? time_start : time_end
        labelStyle = positionLabelsInput == "Left" ? label.style_label_right : label.style_label_left
        
        if ratio == 0.0
            ln = line.new(time_start, pivot, time_end, pivot, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            array.push(lines_arr, ln)
            
            labelText = showLabelsInput ? "PP" : ""
            priceText = showPricesInput ? " (" + str.tostring(pivot, format.mintick) + ")" : ""
            if labelText != "" or priceText != ""
                lb = label.new(labelTime, pivot, labelText + priceText, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
                array.push(labels_arr, lb)
        else
            lnR = line.new(time_start, priceR, time_end, priceR, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            array.push(lines_arr, lnR)
            
            lnS = line.new(time_start, priceS, time_end, priceS, xloc=xloc.bar_time, color=col, width=lineWidth, style=lineStyle)
            array.push(lines_arr, lnS)
            
            rName = "R" + str.tostring(levelNum) + " PP " + str.tostring(ratio)
            rPrice = showPricesInput ? " (" + str.tostring(priceR, format.mintick) + ")" : ""
            rLabel = showLabelsInput ? rName + rPrice : str.tostring(ratio) + rPrice
            lbR = label.new(labelTime, priceR, rLabel, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
            array.push(labels_arr, lbR)
            
            sName = "S" + str.tostring(levelNum) + " PP " + str.tostring(ratio)
            sPrice = showPricesInput ? " (" + str.tostring(priceS, format.mintick) + ")" : ""
            sLabel = showLabelsInput ? sName + sPrice : str.tostring(ratio) + sPrice
            lbS = label.new(labelTime, priceS, sLabel, xloc=xloc.bar_time, style=labelStyle, color=#00000000, textcolor=col, size=size.small)
            array.push(labels_arr, lbS)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW ALL 13 LEVELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
drawPivotLevel(pp_show, pp_ratio, pp_color, pp_style, 0)
drawPivotLevel(l1_show, l1_ratio, l1_color, l1_style, 1)
drawPivotLevel(l2_show, l2_ratio, l2_color, l2_style, 2)
drawPivotLevel(l3_show, l3_ratio, l3_color, l3_style, 3)
drawPivotLevel(l4_show, l4_ratio, l4_color, l4_style, 4)
drawPivotLevel(l5_show, l5_ratio, l5_color, l5_style, 5)
drawPivotLevel(l6_show, l6_ratio, l6_color, l6_style, 6)
drawPivotLevel(l7_show, l7_ratio, l7_color, l7_style, 7)
drawPivotLevel(l8_show, l8_ratio, l8_color, l8_style, 8)
drawPivotLevel(l9_show, l9_ratio, l9_color, l9_style, 9)
drawPivotLevel(l10_show, l10_ratio, l10_color, l10_style, 10)
drawPivotLevel(l11_show, l11_ratio, l11_color, l11_style, 11)
drawPivotLevel(l12_show, l12_ratio, l12_color, l12_style, 12)
drawPivotLevel(l13_show, l13_ratio, l13_color, l13_style, 13)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(ta.cross(close, pivot), "Cross Pivot Point", "Price crossed Pivot Point")
