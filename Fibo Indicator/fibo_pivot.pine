//@version=6
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• //
//# * Simplified Fibonacci Pivot Points
//# * Author: Â© Vinh (Based on dgtrd)
//# * Features: Auto HTF, Clean Pivot Points Lines
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• //

indicator('Fibo Pivot Points', 'FIB PP', true, max_lines_count = 50, max_labels_count = 50)

// ==========================================
// SETTINGS
// ==========================================
group_pp = 'ğŸ“Š Pivot Points'

i_showLabels = input.bool(true, 'Hiá»‡n Labels vá»›i GiÃ¡', group = group_pp)
i_extend = input.bool(false, 'Má»Ÿ rá»™ng Ä‘Æ°á»ng Pivot', group = group_pp)

// Fibonacci Levels
group_levels = 'ğŸ¨ Fibonacci Levels'

show_pp = input.bool(true, '', inline = 'L0', group = group_levels)
color_pp = input.color(#787b86, 'PP (Pivot)', inline = 'L0', group = group_levels)

show_382 = input.bool(true, '', inline = 'L1', group = group_levels)
color_382 = input.color(#81c784, 'S1/R1 (0.382)', inline = 'L1', group = group_levels)

show_618 = input.bool(true, '', inline = 'L2', group = group_levels)
color_618 = input.color(#009688, 'S2/R2 (0.618)', inline = 'L2', group = group_levels)

show_1 = input.bool(true, '', inline = 'L3', group = group_levels)
color_1 = input.color(#2196f3, 'S3/R3 (1.0)', inline = 'L3', group = group_levels)

// ==========================================
// AUTO TIMEFRAME 
// ==========================================
htf = 
     timeframe.period == '1' or timeframe.period == '3' or timeframe.period == '5' or timeframe.period == '15' ? 'D' :
     timeframe.period == '30' or timeframe.period == '45' or timeframe.period == '60' or timeframe.period == '120' or timeframe.period == '180' or timeframe.period == '240' ? 'W' :
     timeframe.period == 'D' ? 'M' :
     timeframe.period == 'W' ? '3M' :
     timeframe.period == 'M' ? '12M' :
     'W'

// ==========================================
// HTF OHLC - dÃ¹ng request.security trÃ¡nh trÃ¹ng
// ==========================================
[htf_h, htf_l, htf_c] = request.security(syminfo.tickerid, htf, [high[1], low[1], close[1]], lookahead = barmerge.lookahead_on)

// ==========================================
// PIVOT CALCULATIONS
// ==========================================
pivot = (htf_h + htf_l + htf_c) / 3
range_pp = htf_h - htf_l

s1 = pivot - range_pp * 0.382
r1 = pivot + range_pp * 0.382
s2 = pivot - range_pp * 0.618
r2 = pivot + range_pp * 0.618
s3 = pivot - range_pp * 1.0
r3 = pivot + range_pp * 1.0

// ==========================================
// DRAW LINES & LABELS (Chá»‰ váº½ 1 láº§n, khÃ´ng trÃ¹ng)
// ==========================================
var line line_pp = na
var line line_s1 = na, var line line_r1 = na
var line line_s2 = na, var line line_r2 = na
var line line_s3 = na, var line line_r3 = na

var label lbl_pp = na
var label lbl_s1 = na, var label lbl_r1 = na
var label lbl_s2 = na, var label lbl_r2 = na
var label lbl_s3 = na, var label lbl_r3 = na

// XÃ³a cÅ© khi cÃ³ thay Ä‘á»•i HTF
if timeframe.change(htf)
    line.delete(line_pp)
    line.delete(line_s1), line.delete(line_r1)
    line.delete(line_s2), line.delete(line_r2)
    line.delete(line_s3), line.delete(line_r3)
    label.delete(lbl_pp)
    label.delete(lbl_s1), label.delete(lbl_r1)
    label.delete(lbl_s2), label.delete(lbl_r2)
    label.delete(lbl_s3), label.delete(lbl_r3)

// Váº½ lines
extendMode = i_extend ? extend.both : extend.right

if show_pp
    line.delete(line_pp)
    line_pp := line.new(bar_index, pivot, bar_index + 1, pivot, extend = extendMode, color = color_pp, width = 2, style = line.style_solid)

if show_382
    line.delete(line_s1), line.delete(line_r1)
    line_s1 := line.new(bar_index, s1, bar_index + 1, s1, extend = extendMode, color = color_382, width = 2, style = line.style_solid)
    line_r1 := line.new(bar_index, r1, bar_index + 1, r1, extend = extendMode, color = color_382, width = 2, style = line.style_solid)

if show_618
    line.delete(line_s2), line.delete(line_r2)
    line_s2 := line.new(bar_index, s2, bar_index + 1, s2, extend = extendMode, color = color_618, width = 2, style = line.style_solid)
    line_r2 := line.new(bar_index, r2, bar_index + 1, r2, extend = extendMode, color = color_618, width = 2, style = line.style_solid)

if show_1
    line.delete(line_s3), line.delete(line_r3)
    line_s3 := line.new(bar_index, s3, bar_index + 1, s3, extend = extendMode, color = color_1, width = 2, style = line.style_solid)
    line_r3 := line.new(bar_index, r3, bar_index + 1, r3, extend = extendMode, color = color_1, width = 2, style = line.style_solid)

// Labels (chá»‰ hiá»‡n trÃªn bar cuá»‘i vá»›i giÃ¡)
if barstate.islast and i_showLabels
    label.delete(lbl_pp)
    label.delete(lbl_s1), label.delete(lbl_r1)
    label.delete(lbl_s2), label.delete(lbl_r2)
    label.delete(lbl_s3), label.delete(lbl_r3)
    
    if show_pp
        lbl_pp := label.new(bar_index + 10, pivot, 'PP (' + str.tostring(pivot, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_pp, style = label.style_label_left, size = size.small)
    if show_382
        lbl_s1 := label.new(bar_index + 10, s1, 'S1 (' + str.tostring(s1, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_382, style = label.style_label_left, size = size.small)
        lbl_r1 := label.new(bar_index + 10, r1, 'R1 (' + str.tostring(r1, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_382, style = label.style_label_left, size = size.small)
    if show_618
        lbl_s2 := label.new(bar_index + 10, s2, 'S2 (' + str.tostring(s2, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_618, style = label.style_label_left, size = size.small)
        lbl_r2 := label.new(bar_index + 10, r2, 'R2 (' + str.tostring(r2, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_618, style = label.style_label_left, size = size.small)
    if show_1
        lbl_s3 := label.new(bar_index + 10, s3, 'S3 (' + str.tostring(s3, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_1, style = label.style_label_left, size = size.small)
        lbl_r3 := label.new(bar_index + 10, r3, 'R3 (' + str.tostring(r3, format.mintick) + ')', color = color.new(color.white, 100), textcolor = color_1, style = label.style_label_left, size = size.small)

// ==========================================
// ALERTS
// ==========================================
alertcondition(ta.cross(close, pivot), 'Cross PP', 'GiÃ¡ cáº¯t Pivot Point')
alertcondition(ta.cross(close, s1) or ta.cross(close, r1), 'Cross S1/R1', 'GiÃ¡ cáº¯t S1 hoáº·c R1')
alertcondition(ta.cross(close, s2) or ta.cross(close, r2), 'Cross S2/R2', 'GiÃ¡ cáº¯t S2 hoáº·c R2')
